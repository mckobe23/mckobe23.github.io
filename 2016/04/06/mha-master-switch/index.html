<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="快乐每一天 夏虫不可以语冰"><title>MHA故障转移之masterha_master_switch | 喀秋莎的技术博客</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">MHA故障转移之masterha_master_switch</h1><a id="logo" href="/.">喀秋莎的技术博客</a><p class="description">快乐每一天 夏虫不可以语冰</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">MHA故障转移之masterha_master_switch</h1><div class="post-meta">Apr 6, 2016<span> | </span><span class="category"><a href="/categories/mysql/">mysql</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/04/06/mha-master-switch/" href="/2016/04/06/mha-master-switch/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h3 id="MHA有两个故障转移工具，分别支持手动和自动切换"><a href="#MHA有两个故障转移工具，分别支持手动和自动切换" class="headerlink" title="MHA有两个故障转移工具，分别支持手动和自动切换"></a>MHA有两个故障转移工具，分别支持手动和自动切换</h3><p>两个工具各有用武之地，如果你想高可用快速failover，那么自动切换是一个不错的选择；<br>如果需要一些维护性切换，那么手动切换可以满足，并且做成平台自动化的话，可以调用手动切换脚本</p>
<p><strong>masterha_master_switch</strong><br>既然是手动切换，那么不管master是好是坏，我们想切就切：）</p>
<p>这个时候，我们可以告诉master_switch，master到底是好的还是坏的，并且可以指定新主</p>
<p><strong>环境</strong></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">manager <span class="number">10.20</span><span class="number">.64</span><span class="number">.209</span></div><div class="line">node1	<span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span> master</div><div class="line">node2	<span class="number">10.20</span><span class="number">.64</span><span class="number">.203</span> candidate</div><div class="line">node3	<span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span> candidate</div><div class="line">node4	<span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span> no master</div><div class="line"></div><div class="line">mysql&gt; show slave hosts;</div><div class="line">+-----------+------+------+-----------+--------------------------------------+</div><div class="line">| Server_id | Host | Port | Master_id | Slave_UUID                           |</div><div class="line">+-----------+------+------+-----------+--------------------------------------+</div><div class="line">|       <span class="number">203</span> |      | <span class="number">3306</span> |       <span class="number">202</span> | <span class="number">1</span>ecea136-e9c5<span class="number">-11e5</span><span class="number">-81e7</span><span class="number">-005056</span>ac51d6 |</div><div class="line">|       <span class="number">204</span> |      | <span class="number">3306</span> |       <span class="number">202</span> | <span class="number">1</span>f21f462-e9c5<span class="number">-11e5</span><span class="number">-81e7</span><span class="number">-005056</span>ac02c4 |</div><div class="line">|       <span class="number">210</span> |      | <span class="number">3306</span> |       <span class="number">202</span> | c34b6df4-f0c3<span class="number">-11e5</span>-af82<span class="number">-005056</span>ac361f |</div><div class="line">+-----------+------+------+-----------+--------------------------------------+</div><div class="line"><span class="number">3</span> rows in set (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>
<p><strong>switch切换</strong><br>本次测试为主从静态切换，所以不存在丢数据的情况，我们的目的是了解下switch的切换机制（后续我们会在进行动态切换后数据一致性的测试）</p>
<p>手动切换会有一些人机交互的内容，如果你懒得回答那些问题，只希望控制是否切换，而剩下的工作全权交给mha去做的话，可以加上--interactive=0这个参数</p>
<h4 id="这里有几个参数值得说一下"><a href="#这里有几个参数值得说一下" class="headerlink" title="这里有几个参数值得说一下"></a>这里有几个参数值得说一下</h4><p>对于维护性切换，比如升级个硬件啥的，这几个参数可以这样结合的使用，省时省力</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>interactive=0</td>
<td>无需交互，按照给定的选项自动执行</td>
</tr>
<tr>
<td>new_master_host=10.20.64.204</td>
<td>指定新主</td>
</tr>
<tr>
<td>orig_master_is_new_slave</td>
<td>它可以在alive模式切换后，将老主库与新主建立同步，华丽变身为从库（我们可以随意下线维护了：））</td>
</tr>
<tr>
<td>remove_orig_master_conf</td>
<td>从配置文件清理老主库信息</td>
</tr>
</tbody>
</table>
<hr>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[mha@n-op-209 etc]$ masterha<span class="emphasis">_master_</span>switch --conf=/usr/local/mha-manager/etc/test.conf --master<span class="emphasis">_state=dead --dead_</span>master_host=10.20.64.202</div><div class="line"></div><div class="line">Wed Apr  6 17:03:12 2016 - [info] Dead Servers:</div><div class="line">Wed Apr  6 17:03:12 2016 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/MasterFailover.pm, ln187</span>] None of server is dead. Stop failover.</div><div class="line">Wed Apr  6 17:03:12 2016 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/ManagerUtil.pm, ln177</span>] Got ERROR:  at /usr/local/mha-manager/bin/masterha<span class="emphasis">_master_</span>switch line 53.</div></pre></td></tr></table></figure>
<p>如果你的master并没有坏，会停止切换<br>所以，我们改用alive的方式</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div></pre></td><td class="code"><pre><div class="line">[<span class="name">mha@n-op-209</span> etc]$ masterha_master_switch --conf=/usr/local/mha-manager/etc/test.conf --master_state=alive</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:23 <span class="number">2016</span> - [<span class="name">info</span>] MHA::MasterRotate version <span class="number">0.56</span>.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:23 <span class="number">2016</span> - [<span class="name">info</span>] Starting online master switch..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:23 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:23 <span class="number">2016</span> - [<span class="name">info</span>] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:23 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:23 <span class="number">2016</span> - [<span class="name">warning</span>] Global configuration file /etc/masterha_default.cnf not found. Skipping.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:23 <span class="number">2016</span> - [<span class="name">info</span>] Reading application default configuration from /usr/local/mha-manager/etc/test.conf..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:23 <span class="number">2016</span> - [<span class="name">info</span>] Reading server configuration from /usr/local/mha-manager/etc/test.conf..</div><div class="line">读取配置信息后，开始检测</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:24 <span class="number">2016</span> - [<span class="name">info</span>] GTID failover mode = <span class="number">0</span></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:24 <span class="number">2016</span> - [<span class="name">info</span>] Current Alive Master: <span class="number">10.20</span>.64.202(<span class="name">10.20.64.202:3306</span>)</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:24 <span class="number">2016</span> - [<span class="name">info</span>] Alive Slaves:</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:24 <span class="number">2016</span> - [<span class="name">info</span>]   <span class="number">10.20</span>.64.203(<span class="name">10.20.64.203:3306</span>)  Version=5.6.27-76.0-log (<span class="name">oldest</span> major version between slaves) log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:24 <span class="number">2016</span> - [<span class="name">info</span>]     Replicating from <span class="number">10.20</span>.64.202(<span class="name">10.20.64.202:3306</span>)</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:24 <span class="number">2016</span> - [<span class="name">info</span>]     Primary candidate for the new Master (<span class="name">candidate_master</span> is set)</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:24 <span class="number">2016</span> - [<span class="name">info</span>]   <span class="number">10.20</span>.64.204(<span class="name">10.20.64.204:3306</span>)  Version=5.6.27-76.0-log (<span class="name">oldest</span> major version between slaves) log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:24 <span class="number">2016</span> - [<span class="name">info</span>]     Replicating from <span class="number">10.20</span>.64.202(<span class="name">10.20.64.202:3306</span>)</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:24 <span class="number">2016</span> - [<span class="name">info</span>]     Primary candidate for the new Master (<span class="name">candidate_master</span> is set)</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:24 <span class="number">2016</span> - [<span class="name">info</span>]   <span class="number">10.20</span>.64.210(<span class="name">10.20.64.210:3306</span>)  Version=5.6.27-76.0-log (<span class="name">oldest</span> major version between slaves) log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:24 <span class="number">2016</span> - [<span class="name">info</span>]     Replicating from <span class="number">10.20</span>.64.202(<span class="name">10.20.64.202:3306</span>)</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:24 <span class="number">2016</span> - [<span class="name">info</span>]     Not candidate for the new Master (<span class="name">no_master</span> is set)</div><div class="line">这段是由masterha_check_repl输出的</div><div class="line"></div><div class="line">It is better to execute FLUSH NO_WRITE_TO_BINLOG TABLES on the master before switching. Is it ok to execute on <span class="number">10.20</span>.64.202(<span class="name">10.20.64.202:3306</span>)? (<span class="name">YES/no</span>): yes</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>] Executing FLUSH NO_WRITE_TO_BINLOG TABLES. This may take long time..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]  ok.</div><div class="line">是否允许主库本地执行Flush Tables，以下执行语句不会写入binlog，所以不会被同步到从库</div><div class="line">回答：yes</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>] Checking MHA is not monitoring or doing failover..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>] Checking replication health on <span class="number">10.20</span>.64.203..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]  ok.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>] Checking replication health on <span class="number">10.20</span>.64.204..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]  ok.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>] Checking replication health on <span class="number">10.20</span>.64.210..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]  ok.</div><div class="line">逐个检查从库同步健康情况</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>] Searching new master from slaves..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]  Candidate masters from the configuration file:</div><div class="line">从配置文件读取候选人信息</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]   <span class="number">10.20</span>.64.202(<span class="name">10.20.64.202:3306</span>)  Version=5.6.27-76.0-log log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]   <span class="number">10.20</span>.64.203(<span class="name">10.20.64.203:3306</span>)  Version=5.6.27-76.0-log (<span class="name">oldest</span> major version between slaves) log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]     Replicating from <span class="number">10.20</span>.64.202(<span class="name">10.20.64.202:3306</span>)</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]     Primary candidate for the new Master (<span class="name">candidate_master</span> is set)</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]   <span class="number">10.20</span>.64.204(<span class="name">10.20.64.204:3306</span>)  Version=5.6.27-76.0-log (<span class="name">oldest</span> major version between slaves) log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]     Replicating from <span class="number">10.20</span>.64.202(<span class="name">10.20.64.202:3306</span>)</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]     Primary candidate for the new Master (<span class="name">candidate_master</span> is set)</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]  Non-candidate masters:</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]   <span class="number">10.20</span>.64.210(<span class="name">10.20.64.210:3306</span>)  Version=5.6.27-76.0-log (<span class="name">oldest</span> major version between slaves) log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]     Replicating from <span class="number">10.20</span>.64.202(<span class="name">10.20.64.202:3306</span>)</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]     Not candidate for the new Master (<span class="name">no_master</span> is set)</div><div class="line">这段是由masterha_check_repl输出的</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]  Searching from candidate_master slaves which have received the latest relay log events..</div><div class="line">从候选人中寻找relay log中记录的事件最新的从库</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:28 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">From:</div><div class="line"><span class="number">10.20</span>.64.202(<span class="name">10.20.64.202:3306</span>) (<span class="name">current</span> master) (<span class="name">test</span> master)</div><div class="line"> +--10.20.64.203(<span class="name">10.20.64.203:3306</span>) (<span class="name">test</span> standby)</div><div class="line"> +--10.20.64.204(<span class="name">10.20.64.204:3306</span>) (<span class="name">test</span> standby)</div><div class="line"> +--10.20.64.210(<span class="name">10.20.64.210:3306</span>) (<span class="name">test</span> slave)</div><div class="line">描述下当前架构</div><div class="line"></div><div class="line">To:</div><div class="line"><span class="number">10.20</span>.64.203(<span class="name">10.20.64.203:3306</span>) (<span class="name">new</span> master) (<span class="name">test</span> standby)</div><div class="line"> +--10.20.64.204(<span class="name">10.20.64.204:3306</span>) (<span class="name">test</span> standby)</div><div class="line"> +--10.20.64.210(<span class="name">10.20.64.210:3306</span>) (<span class="name">test</span> slave)</div><div class="line">mha甄别后推荐的新架构</div><div class="line"></div><div class="line">Starting master switch from <span class="number">10.20</span>.64.202(<span class="name">10.20.64.202:3306</span>) to <span class="number">10.20</span>.64.203(<span class="name">10.20.64.203:3306</span>)? (<span class="name">yes/NO</span>): no</div><div class="line">mha：是否使用它推荐的203作为新主</div><div class="line">答：no</div><div class="line">（这里主要是想了解下，它还会问啥：）） </div><div class="line"></div><div class="line">Continue? (<span class="name">yes/NO</span>): yes</div><div class="line">mha：是否还要继续</div><div class="line">答：yes</div><div class="line"></div><div class="line">Enter new master host name: <span class="number">10.20</span>.64.204</div><div class="line">mha：输入我希望的新主</div><div class="line"></div><div class="line">Master switch to <span class="number">10.20</span>.64.204(<span class="name">10.20.64.204:3306</span>). OK? (<span class="name">yes/NO</span>): yes</div><div class="line">mha：再次问我确定选择这个新主么？</div><div class="line">答：yes</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:37 <span class="number">2016</span> - [<span class="name">info</span>] Checking whether <span class="number">10.20</span>.64.204(<span class="name">10.20.64.204:3306</span>) is ok for the new master..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:37 <span class="number">2016</span> - [<span class="name">info</span>]  ok.</div><div class="line">开始检测新主</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:37 <span class="number">2016</span> - [<span class="name">info</span>] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:37 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">第一阶段：检测配置</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:37 <span class="number">2016</span> - [<span class="name">info</span>] * Phase <span class="number">2</span>: Rejecting updates Phase..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:37 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">第二阶段：拒接更新</div><div class="line"></div><div class="line">master_ip_online_change_script is not defined. If you do not disable writes on the current master manually, applications keep writing on the current master. Is it ok to proceed? (<span class="name">yes/NO</span>): yes</div><div class="line">首先交代下我们没有自定义切换脚本</div><div class="line"></div><div class="line">其次，从这里我们可以知道，如果我们不手动控制老主库的写操作，mha是不会做任何处理的。也就是说，在切换的过程中，在应用写指向没有改到新主的时候（或者高可用，路由指向还没有被更新到新主的时候），写操作会持续不断的写入老主库</div><div class="line">（这个环节有很多值得我们思考的地方，所以建议DBA编写自定义failover脚本，处理老库写操作问题）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>] Locking all tables on the orig master to reject updates from everybody (<span class="name">including</span> root):</div><div class="line">将老主库锁全表（包括mysql root用户更新操作）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>] Executing FLUSH TABLES WITH READ LOCK..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  ok.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>] Orig master binlog:pos is mysql-bin.000001:120.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  Waiting to execute all relay logs on <span class="number">10.20</span>.64.204(<span class="name">10.20.64.204:3306</span>)..</div><div class="line">这里加了一个读锁，只允许读，不允许写，并获取老主库binlog和pos点</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  master_pos_wait(<span class="name">mysql-bin.000001:120</span>) completed on <span class="number">10.20</span>.64.204(<span class="name">10.20.64.204:3306</span>). Executed <span class="number">0</span> events.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]   done.</div><div class="line">等待新主执行完所有的relay log</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>] Getting new master<span class="symbol">'s</span> binlog name and position..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  mysql-bin.000004:120</div><div class="line">获取新主的binlog和pos点</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span class="symbol">'10.20.64.204</span>', MASTER_PORT=3306, MASTER_LOG_FILE=<span class="symbol">'mysql-bin.000004</span>', MASTER_LOG_POS=120, MASTER_USER=<span class="symbol">'repl</span>', MASTER_PASSWORD=<span class="symbol">'xxx</span>'<span class="comment">;</span></div><div class="line">所有的其它从库，重新与新主建立同步</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>] Setting read_only=0 on <span class="number">10.20</span>.64.204(<span class="name">10.20.64.204:3306</span>)..</div><div class="line">以前我们的候选人是读库，所以read_only=1</div><div class="line">现在它被切换为新主，需要支持写操作，mha在这里设置read_only=0</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  ok.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>] * Switching slaves in parallel..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>] -- Slave switch on host <span class="number">10.20</span>.64.203(<span class="name">10.20.64.203:3306</span>) started, pid: <span class="number">30094</span></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">(<span class="name">node2</span>)</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>] -- Slave switch on host <span class="number">10.20</span>.64.210(<span class="name">10.20.64.210:3306</span>) started, pid: <span class="number">30095</span></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">(<span class="name">node4</span>)</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>] Log messages from <span class="number">10.20</span>.64.203 ...</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  Waiting to execute all relay logs on <span class="number">10.20</span>.64.203(<span class="name">10.20.64.203:3306</span>)..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  master_pos_wait(<span class="name">mysql-bin.000001:120</span>) completed on <span class="number">10.20</span>.64.203(<span class="name">10.20.64.203:3306</span>). Executed <span class="number">0</span> events.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]   done.</div><div class="line">首先执行完积压的relay log</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  Resetting slave <span class="number">10.20</span>.64.203(<span class="name">10.20.64.203:3306</span>) and starting replication from the new master <span class="number">10.20</span>.64.204(<span class="name">10.20.64.204:3306</span>)..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  Executed CHANGE MASTER.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  Slave started.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>] End of log messages from <span class="number">10.20</span>.64.203 ...</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>] -- Slave switch on host <span class="number">10.20</span>.64.203(<span class="name">10.20.64.203:3306</span>) succeeded.</div><div class="line">然后重置同步，建立与新主的同步，切同步成功</div><div class="line">这段是由node本地脚本apply_diff_relay_logs输出的</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>] Log messages from <span class="number">10.20</span>.64.210 ...</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  Waiting to execute all relay logs on <span class="number">10.20</span>.64.210(<span class="name">10.20.64.210:3306</span>)..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  master_pos_wait(<span class="name">mysql-bin.000001:120</span>) completed on <span class="number">10.20</span>.64.210(<span class="name">10.20.64.210:3306</span>). Executed <span class="number">0</span> events.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]   done.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  Resetting slave <span class="number">10.20</span>.64.210(<span class="name">10.20.64.210:3306</span>) and starting replication from the new master <span class="number">10.20</span>.64.204(<span class="name">10.20.64.204:3306</span>)..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  Executed CHANGE MASTER.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:39 <span class="number">2016</span> - [<span class="name">info</span>]  Slave started.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>] End of log messages from <span class="number">10.20</span>.64.210 ...</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>] -- Slave switch on host <span class="number">10.20</span>.64.210(<span class="name">10.20.64.210:3306</span>) succeeded.</div><div class="line">到这里，所有从库与新主同步已建立完成，切同步成功</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>] Unlocking all tables on the orig master:</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>] Executing UNLOCK TABLES..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>]  ok.</div><div class="line">解锁老库读锁</div><div class="line">（再次提起，应用指向未改的情况下，老库的写操作还会继续，且不会被同步到从库，数据不一致就是在这个环节产生的，有可能丢失1秒钟的数据。所以，最好在自定义脚本中先处理下这个问题）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>] All new slave servers switched successfully.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">所有从库已经切换成功</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>]</div><div class="line">第五阶段：清理新主（我们show slave hosts内容为空就对了，不过根据我的观察，这个结果有延迟）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>]  <span class="number">10.20</span>.64.204: Resetting slave info succeeded.</div><div class="line">重置新主的slave状态（我们show slave status\G内容为空就对了）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">14</span>:04:40 <span class="number">2016</span> - [<span class="name">info</span>] Switching master to <span class="number">10.20</span>.64.204(<span class="name">10.20.64.204:3306</span>) completed successfully.</div><div class="line">至此切换完毕</div></pre></td></tr></table></figure>
<p>我们来看mysql<br>旧主: 10.20.64.202</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show slave hosts<span class="comment">;</span></div><div class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> <span class="keyword">sec</span>)</div></pre></td></tr></table></figure>
<p>新主: 10.20.64.204</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="section">mmysql&gt; show slave hosts;</span></div><div class="line">+-----------+------+------+-----------+--------------------------------------+</div><div class="line"><span class="section">| Server_id | Host | Port | Master_id | Slave_UUID                           |</span></div><div class="line">+-----------+------+------+-----------+--------------------------------------+</div><div class="line">|       203 |      | 3306 |       204 | 1ecea136-e9c5-11e5-81e7-005056ac51d6 |</div><div class="line"><span class="section">|       210 |      | 3306 |       204 | c34b6df4-f0c3-11e5-af82-005056ac361f |</span></div><div class="line">+-----------+------+------+-----------+--------------------------------------+</div><div class="line">2 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>新主binlog</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show master status\G</div><div class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></div><div class="line"><span class="code">             File: mysql-bin.000004</span></div><div class="line"><span class="code">         Position: 120</span></div><div class="line"><span class="code">     Binlog_Do_DB:</span></div><div class="line"> Binlog<span class="emphasis">_Ignore_</span>DB:</div><div class="line">Executed<span class="emphasis">_Gtid_</span>Set:</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>新的主从同步抽样</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show slave status\G</div><div class="line">*************************** <span class="number">1.</span> row ***************************</div><div class="line"><span class="attr">               Slave_IO_State:</span> Waiting for master to send event</div><div class="line"><span class="attr">                  Master_Host:</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span></div><div class="line"><span class="attr">                  Master_User:</span> repl</div><div class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></div><div class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></div><div class="line"><span class="attr">              Master_Log_File:</span> mysql-bin<span class="number">.000004</span></div><div class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">120</span></div><div class="line"><span class="attr">               Relay_Log_File:</span> relay-bin<span class="number">.000002</span></div><div class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">283</span></div><div class="line"><span class="attr">        Relay_Master_Log_File:</span> mysql-bin<span class="number">.000004</span></div><div class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></div><div class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></div><div class="line"><span class="attr">              Replicate_Do_DB:</span></div><div class="line"><span class="attr">          Replicate_Ignore_DB:</span></div><div class="line"><span class="attr">           Replicate_Do_Table:</span></div><div class="line"><span class="attr">       Replicate_Ignore_Table:</span></div><div class="line"><span class="attr">      Replicate_Wild_Do_Table:</span></div><div class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span></div><div class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></div><div class="line"><span class="attr">                   Last_Error:</span></div><div class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></div><div class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">120</span></div><div class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">450</span></div><div class="line"><span class="attr">              Until_Condition:</span> None</div><div class="line"><span class="attr">               Until_Log_File:</span></div><div class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></div><div class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></div><div class="line"><span class="attr">           Master_SSL_CA_File:</span></div><div class="line"><span class="attr">           Master_SSL_CA_Path:</span></div><div class="line"><span class="attr">              Master_SSL_Cert:</span></div><div class="line"><span class="attr">            Master_SSL_Cipher:</span></div><div class="line"><span class="attr">               Master_SSL_Key:</span></div><div class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></div><div class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></div><div class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></div><div class="line"><span class="attr">                Last_IO_Error:</span></div><div class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></div><div class="line"><span class="attr">               Last_SQL_Error:</span></div><div class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span></div><div class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">204</span></div><div class="line"><span class="attr">                  Master_UUID:</span> <span class="number">1</span>f21f462-e9c5<span class="bullet">-11e5</span><span class="bullet">-81e7</span><span class="bullet">-005056</span>ac02c4</div><div class="line"><span class="attr">             Master_Info_File:</span> mysql.slave_master_info</div><div class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></div><div class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></div><div class="line"><span class="attr">      Slave_SQL_Running_State:</span> Slave has read all relay log; waiting for the slave I/O thread to update it</div><div class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></div><div class="line"><span class="attr">                  Master_Bind:</span></div><div class="line"><span class="attr">      Last_IO_Error_Timestamp:</span></div><div class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span></div><div class="line"><span class="attr">               Master_SSL_Crl:</span></div><div class="line"><span class="attr">           Master_SSL_Crlpath:</span></div><div class="line"><span class="attr">           Retrieved_Gtid_Set:</span></div><div class="line"><span class="attr">            Executed_Gtid_Set:</span></div><div class="line"><span class="attr">                Auto_Position:</span> <span class="number">0</span></div><div class="line"><span class="number">1</span> row in set (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>
<hr>
<p><strong>我们来看看切换的过程中，mha对mysql做了哪些操作</strong></p>
<p>老主库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">    Time Id Command Argument</div><div class="line">14:04:23 37 Connect mha@10.20.64.209 on</div><div class="line">         37 Query   <span class="keyword">set</span> autocommit=<span class="number">1</span></div><div class="line">         <span class="number">37</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> CONNECTION_ID() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">24</span> <span class="number">38</span> <span class="keyword">Connect</span> mha@<span class="number">10.20</span><span class="number">.64</span><span class="number">.209</span> <span class="keyword">on</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">set</span> autocommit=<span class="number">1</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> CONNECTION_ID() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SET</span> wait_timeout=<span class="number">86400</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.server_id <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">VERSION</span>() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.gtid_mode <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'log_bin'</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">MASTER</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.datadir <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.slave_parallel_workers <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.read_only <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.relay_log_purge <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         </div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">28</span> <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">FLUSH</span> <span class="keyword">NO_WRITE_TO_BINLOG</span> <span class="keyword">TABLES</span></div><div class="line">与日志对应，刷不写<span class="keyword">binlog</span></div><div class="line"></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">GET_LOCK</span>(<span class="string">'MHA_Master_High_Availability_Monitor'</span>, <span class="string">'0'</span>) <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">获取MHA Monitor的应用锁         </div><div class="line">         </div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">PROCESSLIST</span></div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">37</span> <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">RELEASE_LOCK</span>(<span class="string">'MHA_Master_High_Availability_Monitor'</span>) <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">释放MHA Monitor的应用锁 </div><div class="line"></div><div class="line">         <span class="number">38</span> Quit</div><div class="line">         </div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">39</span> <span class="number">39</span> <span class="keyword">Connect</span> mha@<span class="number">10.20</span><span class="number">.64</span><span class="number">.209</span> <span class="keyword">on</span></div><div class="line">         <span class="number">39</span> <span class="keyword">Query</span>   <span class="keyword">set</span> autocommit=<span class="number">1</span></div><div class="line">         <span class="number">39</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> CONNECTION_ID() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">39</span> <span class="keyword">Query</span>   <span class="keyword">SET</span> wait_timeout=<span class="number">86400</span></div><div class="line">         </div><div class="line">         <span class="number">39</span> <span class="keyword">Query</span>   <span class="keyword">FLUSH</span> <span class="keyword">TABLES</span> <span class="keyword">WITH</span> <span class="keyword">READ</span> <span class="keyword">LOCK</span></div><div class="line">与日志对应，刷读锁</div><div class="line"></div><div class="line">         <span class="number">39</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">MASTER</span> <span class="keyword">STATUS</span></div><div class="line">与日志对应，获取主库<span class="keyword">binlog</span>和pos</div><div class="line"></div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">40</span> <span class="number">39</span> <span class="keyword">Query</span>   <span class="keyword">UNLOCK</span> <span class="keyword">TABLES</span></div><div class="line">与日志对应，释放读锁</div><div class="line"></div><div class="line">         <span class="number">39</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">RELEASE_LOCK</span>(<span class="string">'MHA_Master_High_Availability_Failover'</span>) <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">释放MHA <span class="keyword">Failover</span>锁</div><div class="line">（好奇怪，前面并没有加锁）</div><div class="line"></div><div class="line">         <span class="number">39</span> Quit</div></pre></td></tr></table></figure>
<p>新主库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">    Time Id Command Argument</div><div class="line">14:04:23 35 Connect mha@10.20.64.209 on</div><div class="line">         35 Query   <span class="keyword">set</span> autocommit=<span class="number">1</span></div><div class="line">         <span class="number">35</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> CONNECTION_ID() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">24</span> <span class="number">36</span> <span class="keyword">Connect</span> mha@<span class="number">10.20</span><span class="number">.64</span><span class="number">.209</span> <span class="keyword">on</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">set</span> autocommit=<span class="number">1</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> CONNECTION_ID() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SET</span> wait_timeout=<span class="number">86400</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.server_id <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">VERSION</span>() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.gtid_mode <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'log_bin'</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">MASTER</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.datadir <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.slave_parallel_workers <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.read_only <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.relay_log_purge <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.relay_log_info_repository <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         </div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> Relay_log_name <span class="keyword">FROM</span> mysql.slave_relay_log_info</div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.datadir <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> Repl_slave_priv <span class="keyword">AS</span> <span class="keyword">Value</span> <span class="keyword">FROM</span> mysql.user <span class="keyword">WHERE</span> <span class="keyword">user</span> = <span class="string">'repl'</span></div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">28</span> <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">GET_LOCK</span>(<span class="string">'MHA_Master_High_Availability_Failover'</span>, <span class="string">'0'</span>) <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">获取MHA <span class="keyword">Failover</span>锁</div><div class="line"></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">37</span> <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">PROCESSLIST</span></div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">39</span> <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">上面获取了很多状态信息</div><div class="line"></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">MASTER_POS_WAIT</span>(<span class="string">'mysql-bin.000001'</span>,<span class="string">'120'</span>,<span class="number">0</span>) <span class="keyword">AS</span> <span class="keyword">Result</span></div><div class="line">这里使用<span class="keyword">MASTER_POS_WAIT</span>确保该实例读取并执行完成到指定<span class="keyword">binlog</span>位置</div><div class="line"></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">STOP</span> <span class="keyword">SLAVE</span> SQL_THREAD</div><div class="line">停止同步的<span class="keyword">SQL</span>线程，也就是说，即使还有relay <span class="keyword">log</span>堆积，也放弃执行后面的语句</div><div class="line"></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">MASTER</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.read_only <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.read_only <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> read_only=<span class="number">0</span></div><div class="line">与日志影响，这是新主read_only=<span class="number">0</span>，支持写操作</div><div class="line"></div><div class="line">         <span class="number">37</span> <span class="keyword">Connect</span> repl@<span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span> <span class="keyword">on</span>         </div><div class="line">         <span class="number">37</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">UNIX_TIMESTAMP</span>()</div><div class="line">         <span class="number">37</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'SERVER_ID'</span></div><div class="line">         <span class="number">37</span> <span class="keyword">Query</span>   <span class="keyword">SET</span> @master_heartbeat_period= <span class="number">30000001024</span></div><div class="line">         <span class="number">37</span> <span class="keyword">Query</span>   <span class="keyword">SET</span> @master_binlog_checksum= @@global.binlog_checksum</div><div class="line">         <span class="number">37</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @master_binlog_checksum</div><div class="line">         <span class="number">37</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@GLOBAL.GTID_MODE</div><div class="line">         <span class="number">37</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'SERVER_UUID'</span></div><div class="line">         <span class="number">37</span> <span class="keyword">Query</span>   <span class="keyword">SET</span> @slave_uuid= <span class="string">'c34b6df4-f0c3-11e5-af82-005056ac361f'</span></div><div class="line">         <span class="number">37</span> <span class="keyword">Binlog</span> Dump       <span class="keyword">Log</span>: <span class="string">'mysql-bin.000004'</span>  Pos: <span class="number">120</span></div><div class="line">node4从库已完成<span class="keyword">change</span> <span class="keyword">master</span>并<span class="keyword">slave</span> started了         </div><div class="line"></div><div class="line">         <span class="number">38</span> <span class="keyword">Connect</span> repl@<span class="number">10.20</span><span class="number">.64</span><span class="number">.203</span> <span class="keyword">on</span>         </div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">UNIX_TIMESTAMP</span>()</div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'SERVER_ID'</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SET</span> @master_heartbeat_period= <span class="number">30000001024</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SET</span> @master_binlog_checksum= @@global.binlog_checksum</div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @master_binlog_checksum</div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@GLOBAL.GTID_MODE</div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'SERVER_UUID'</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Query</span>   <span class="keyword">SET</span> @slave_uuid= <span class="string">'1ecea136-e9c5-11e5-81e7-005056ac51d6'</span></div><div class="line">         <span class="number">38</span> <span class="keyword">Binlog</span> Dump       <span class="keyword">Log</span>: <span class="string">'mysql-bin.000004'</span>  Pos: <span class="number">120</span></div><div class="line">node2从库已完成<span class="keyword">change</span> <span class="keyword">master</span>并<span class="keyword">slave</span> started了         </div><div class="line"></div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">40</span> <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">STOP</span> <span class="keyword">SLAVE</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">RESET</span> <span class="keyword">SLAVE</span> <span class="comment">/*!50516 ALL */</span></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">与日志对应，停止与老主库同步，重置同步信息</div><div class="line"></div><div class="line">         <span class="number">36</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">RELEASE_LOCK</span>(<span class="string">'MHA_Master_High_Availability_Failover'</span>) <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">释放MHA <span class="keyword">Failover</span>锁</div><div class="line"></div><div class="line">         <span class="number">36</span> Quit</div></pre></td></tr></table></figure>
<p>其余2个从库</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">    Time  Id Command Argument</div><div class="line">14:04:23 220 Connect mha@10.20.64.209 on</div><div class="line">         220 Query   <span class="keyword">set</span> autocommit=<span class="number">1</span></div><div class="line">         <span class="number">220</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> CONNECTION_ID() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">24</span> <span class="number">221</span> <span class="keyword">Connect</span> mha@<span class="number">10.20</span><span class="number">.64</span><span class="number">.209</span> <span class="keyword">on</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">set</span> autocommit=<span class="number">1</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> CONNECTION_ID() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SET</span> wait_timeout=<span class="number">86400</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.server_id <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">VERSION</span>() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.gtid_mode <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'log_bin'</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">MASTER</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.datadir <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.slave_parallel_workers <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.read_only <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.relay_log_purge <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.relay_log_info_repository <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> Relay_log_name <span class="keyword">FROM</span> mysql.slave_relay_log_info</div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.datadir <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">28</span> <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">GET_LOCK</span>(<span class="string">'MHA_Master_High_Availability_Failover'</span>, <span class="string">'0'</span>) <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">获取MHA <span class="keyword">Failover</span>锁</div><div class="line"></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">39</span> <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">MASTER_POS_WAIT</span>(<span class="string">'mysql-bin.000001'</span>,<span class="string">'120'</span>,<span class="number">0</span>) <span class="keyword">AS</span> <span class="keyword">Result</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">STOP</span> <span class="keyword">SLAVE</span> SQL_THREAD</div><div class="line">停止与老主库同步</div><div class="line"></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">STOP</span> <span class="keyword">SLAVE</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">RESET</span> <span class="keyword">SLAVE</span></div><div class="line">重置同步信息</div><div class="line"></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST = <span class="string">'10.20.64.204'</span> MASTER_USER = <span class="string">'repl'</span> MASTER_PASSWORD = &lt;secret&gt; MASTER_PORT = <span class="number">3306</span> MASTER_LOG_FILE = <span class="string">'mysql-bin.000004'</span> MASTER_LOG_POS = <span class="number">120</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">START</span> <span class="keyword">SLAVE</span></div><div class="line">         <span class="number">222</span> <span class="keyword">Connect</span> <span class="keyword">Out</span>       repl@<span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span>:<span class="number">3306</span></div><div class="line">         <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">与日志对应，与新主库建立同步</div><div class="line"></div><div class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">40</span> <span class="number">221</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">RELEASE_LOCK</span>(<span class="string">'MHA_Master_High_Availability_Failover'</span>) <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">释放MHA <span class="keyword">Failover</span>锁</div><div class="line"></div><div class="line">         <span class="number">221</span> Quit</div></pre></td></tr></table></figure>
<hr>
<h4 id="上面模拟了下维护切换，我们更加关心的是故障切换"><a href="#上面模拟了下维护切换，我们更加关心的是故障切换" class="headerlink" title="上面模拟了下维护切换，我们更加关心的是故障切换"></a>上面模拟了下维护切换，我们更加关心的是故障切换</h4><p>我们停止了主库mysqld<br>下面是切换屏显</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[mha<span class="meta">@n</span>-op<span class="number">-209</span> etc]$ masterha_master_switch --conf=<span class="regexp">/usr/</span>local<span class="regexp">/mha-manager/</span>etc/test2.conf --master_state=dead --interactive=<span class="number">0</span> --dead_master_host=<span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span> --new_master_host=<span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span> --remove_orig_master_conf</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">29</span> <span class="number">2016</span> - [warning] Global configuration file <span class="regexp">/etc/</span>masterha_default.cnf not found. Skipping.</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">29</span> <span class="number">2016</span> - [info] Reading application <span class="keyword">default</span> configuration from <span class="regexp">/usr/</span>local<span class="regexp">/mha-manager/</span>etc/test2.conf..</div><div class="line">Thu Apr  <span class="number">7</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">29</span> <span class="number">2016</span> - [info] Reading server configuration from <span class="regexp">/usr/</span>local<span class="regexp">/mha-manager/</span>etc/test2.conf..</div></pre></td></tr></table></figure>
<h4 id="与alive的日志区别，上面看到alive出现了Phase-1、2、5"><a href="#与alive的日志区别，上面看到alive出现了Phase-1、2、5" class="headerlink" title="与alive的日志区别，上面看到alive出现了Phase 1、2、5"></a>与alive的日志区别，上面看到alive出现了Phase 1、2、5</h4><h4 id="Phase-3、4-出现在dead切换中，而且分别还有子阶段，可以更详细的帮助我们了解mha的切换机制"><a href="#Phase-3、4-出现在dead切换中，而且分别还有子阶段，可以更详细的帮助我们了解mha的切换机制" class="headerlink" title="Phase 3、4 出现在dead切换中，而且分别还有子阶段，可以更详细的帮助我们了解mha的切换机制"></a>Phase 3、4 出现在dead切换中，而且分别还有子阶段，可以更详细的帮助我们了解mha的切换机制</h4><p>实际内容会被打到日志中，且只有故障切换会达到日志中</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div></pre></td><td class="code"><pre><div class="line">/usr/local/mha-manager/logs/test.log</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:30</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Thu Apr  <span class="number">7 16:57:30</span> <span class="number">2016</span> - [info]</div><div class="line">第二阶段：主库宕机</div><div class="line">（这里就开始和alive不同了）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:30</span> <span class="number">2016</span> - [info] HealthCheck: SSH to <span class="number">10.20.64.204</span> is reachable.</div><div class="line">检测新主ssh通信</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] Forcing shutdown so that applications never connect to the current master..</div><div class="line">强制停掉，应用不再连接当前主库（老主库）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [warning] master_ip_failover_script is not set. Skipping invalidating dead master IP address.</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]</div><div class="line">第二阶段完成：确定老主库已停掉</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]</div><div class="line">第三阶段：主库恢复阶段</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>.<span class="number">1</span>: Getting Latest Slaves Phase..</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]</div><div class="line">第三阶段第一步：获取执行到最接近最新的binlog和pos点的从库</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] The latest binary log file/position on all slaves is mysql-bin.<span class="number">000004:120</span></div><div class="line">最新的是 mysql-bin.<span class="number">000004:120</span></div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] Latest slaves (Slaves that received relay log files to the latest):</div><div class="line">并且已接收到relay log中</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]   <span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>)  Version=<span class="number">5.6.27-76</span>.<span class="number">0</span>-log (oldest major version between</div><div class="line"> slaves) log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]     Replicating from <span class="number">10.20.64.204</span>(<span class="number">10.20.64.204</span>:<span class="number">3306</span>)</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]     Primary candidate for the new Master (candidate_master is set)</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]   <span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>)  Version=<span class="number">5.6.27-76</span>.<span class="number">0</span>-log (oldest major version between</div><div class="line"> slaves) log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]     Replicating from <span class="number">10.20.64.204</span>(<span class="number">10.20.64.204</span>:<span class="number">3306</span>)</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]     Primary candidate for the new Master (candidate_master is set)</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]   <span class="number">10.20.64.210</span>(<span class="number">10.20.64.210</span>:<span class="number">3306</span>)  Version=<span class="number">5.6.27-76</span>.<span class="number">0</span>-log (oldest major version between</div><div class="line"> slaves) log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]     Replicating from <span class="number">10.20.64.204</span>(<span class="number">10.20.64.204</span>:<span class="number">3306</span>)</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]     Not candidate for the new Master (no_master is set)</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] The oldest binary log file/position on all slaves is mysql-bin.<span class="number">000004:120</span></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] Oldest slaves:</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]   <span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>)  Version=<span class="number">5.6.27-76</span>.<span class="number">0</span>-log (oldest major version between</div><div class="line"> slaves) log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]     Replicating from <span class="number">10.20.64.204</span>(<span class="number">10.20.64.204</span>:<span class="number">3306</span>)</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]     Primary candidate for the new Master (candidate_master is set)</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]   <span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>)  Version=<span class="number">5.6.27-76</span>.<span class="number">0</span>-log (oldest major version between</div><div class="line"> slaves) log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]     Replicating from <span class="number">10.20.64.204</span>(<span class="number">10.20.64.204</span>:<span class="number">3306</span>)</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]     Primary candidate for the new Master (candidate_master is set)</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]   <span class="number">10.20.64.210</span>(<span class="number">10.20.64.210</span>:<span class="number">3306</span>)  Version=<span class="number">5.6.27-76</span>.<span class="number">0</span>-log (oldest major version between</div><div class="line"> slaves) log-bin:enabled</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]     Replicating from <span class="number">10.20.64.204</span>(<span class="number">10.20.64.204</span>:<span class="number">3306</span>)</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]     Not candidate for the new Master (no_master is set)</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]</div><div class="line">这段常规从库检测</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>.<span class="number">2</span>: Saving Dead Master's Binlog Phase..</div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info]</div><div class="line">第三阶段第二步：保存老主库binlog阶段</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] Fetching dead master's binary logs..</div><div class="line">开始获取主库binlog</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] Executing command on the dead master <span class="number">10.20.64.204</span>(<span class="number">10.20.64.204</span>:<span class="number">3306</span>): save_binary_logs -</div><div class="line">-command=save --start_file=mysql-bin.<span class="number">000004</span>  --start_pos=<span class="number">120</span> --binlog_dir=/data/mysqldata/<span class="number">3306</span>/binlog --output_file=/usr/l</div><div class="line">ocal/mha-node/apps/test/saved_master_binlog_from_10.<span class="number">20</span>.<span class="number">64</span>.<span class="number">204</span>_3306_20<span class="number">160407165729</span>.binlog --handle_raw_binlog=<span class="number">1</span> --disable_l</div><div class="line">og_bin=<span class="number">0</span> --manager_version=<span class="number">0</span>.<span class="number">56</span> --client_bindir=/usr/local/mysql/bin --client_libdir=/usr/local/mysql/lib</div><div class="line">老主库本地脚本save_binary_logs读取最新的binlog和pos，将数据保存到node工作目录</div><div class="line"></div><div class="line">  Creating /usr/local/mha-node/apps/test if not exists..    ok.</div><div class="line">  </div><div class="line"> Concat binary/relay logs from mysql-bin.<span class="number">000004</span> pos <span class="number">120</span> to mysql-bin.<span class="number">000004</span> EOF into /usr/local/mha-node/apps/test/saved_m</div><div class="line">aster_binlog_from_10.<span class="number">20</span>.<span class="number">64</span>.<span class="number">204</span>_3306_20<span class="number">160407165729</span>.binlog ..</div><div class="line"> Binlog Checksum enabled</div><div class="line">  Dumping binlog format description event, from position <span class="number">0</span> to <span class="number">120</span>.. ok.</div><div class="line">合并pos点<span class="number">120</span>点到结尾的数据到save_master_binlog文件  </div><div class="line">  </div><div class="line">  Dumping effective binlog data from /data/mysqldata/<span class="number">3306</span>/binlog/mysql-bin.<span class="number">000004</span> position <span class="number">120</span> to tail(<span class="number">143</span>).. ok.</div><div class="line"> Binlog Checksum enabled</div><div class="line"> Concat succeeded.</div><div class="line">最终合并了pos点从<span class="number">120到143</span>的数据</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] scp from mha@<span class="number">10.20.64.204</span>:/usr/local/mha-node/apps/test/saved_master_binlog_from_10.<span class="number">20</span>.<span class="number">6</span></div><div class="line"><span class="number">4</span>.<span class="number">204</span>_3306_20<span class="number">160407165729</span>.binlog to local:/usr/local/mha-manager/apps/test/saved_master_binlog_from_10.<span class="number">20</span>.<span class="number">64</span>.<span class="number">204</span>_<span class="number">3306_2016</span></div><div class="line"><span class="number">0407165729</span>.binlog succeeded.</div><div class="line">将老主库合并后的slave_master_binlog文件通过scp的方式，拿到manager的工作目录</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:31</span> <span class="number">2016</span> - [info] HealthCheck: SSH to <span class="number">10.20.64.203</span> is reachable.</div><div class="line">Thu Apr  <span class="number">7 16:57:32</span> <span class="number">2016</span> - [info] HealthCheck: SSH to <span class="number">10.20.64.202</span> is reachable.</div><div class="line">Thu Apr  <span class="number">7 16:57:32</span> <span class="number">2016</span> - [info] HealthCheck: SSH to <span class="number">10.20.64.210</span> is reachable.</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]</div><div class="line">检测从库ssh通讯</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>.<span class="number">3</span>: Determining New Master Phase..</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]</div><div class="line">第三阶段第三步：确定新主阶段</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] Finding the latest slave that has all relay logs for recovering other slaves..</div><div class="line">寻找所有从库节点中，relay log被恢复到最新pos的从库节点</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] All slaves received relay logs to the same position. No need to resync each other.</div><div class="line">所有的从库全部恢复到同一个pos点。且不需要mha在从节点间做额外的binlog同步操作</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] <span class="number">10.20.64.202</span> can be new master.</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] New master is <span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>)</div><div class="line">按照指定，node1为新主</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] Starting master failover..</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]</div><div class="line">下面开始故障转移工作</div><div class="line"></div><div class="line">From:</div><div class="line"><span class="number">10.20.64.204</span>(<span class="number">10.20.64.204</span>:<span class="number">3306</span>) (current master) (test master)</div><div class="line"> +--<span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>) (test standby)</div><div class="line"> +--<span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>) (test standby)</div><div class="line"> +--<span class="number">10.20.64.210</span>(<span class="number">10.20.64.210</span>:<span class="number">3306</span>) (test slave)</div><div class="line">阐述当前架构</div><div class="line"></div><div class="line">To:</div><div class="line"><span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>) (new master) (test standby)</div><div class="line"> +--<span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>) (test standby)</div><div class="line"> +--<span class="number">10.20.64.210</span>(<span class="number">10.20.64.210</span>:<span class="number">3306</span>) (test slave)</div><div class="line">阐述目标架构</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>.<span class="number">3</span>: New Master Diff Log Generation Phase..</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]</div><div class="line">第三阶段第三步：新主库生成diff log</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]  This server has all relay logs. No need to generate diff files from the latest slave.</div><div class="line">manager服务器拥有全部的relay log，不需要从最近同步的从库生成diff relay log</div><div class="line">(如果这里没有拿到主库的binlog差异，那么需要从最新的slave scp relay log到其他从库，并在其他从库上执行apply_diff_relay_log讲数据补齐）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] Sending binlog..</div><div class="line">这时，将save_binary_logs生成的老主库binlog推送到新主库的工作目录下</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] scp from local:/usr/local/mha-manager/apps/test/saved_master_binlog_from_10.<span class="number">20.64.204_33</span></div><div class="line"><span class="number">06</span>_20<span class="number">160407165729</span>.binlog to mha@<span class="number">10.20.64.202</span>:/usr/local/mha-node/apps/test/saved_master_binlog_from_10.<span class="number">20</span>.<span class="number">64</span>.<span class="number">204</span>_<span class="number">3306_2016</span></div><div class="line"><span class="number">0407165729</span>.binlog succeeded.</div><div class="line">通过scp方式推送到新主的工作目录下</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>.<span class="number">4</span>: Master Log Apply Phase..</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]</div><div class="line">第三阶段第四步：主库binlog应用阶段</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] *NOTICE: If any error happens from this phase, manual recovery is needed.</div><div class="line">提示：如果这个阶段发生报错，那么需要手动去执行apply log操作</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] Starting recovery on <span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>)..</div><div class="line">在新主库上开始执行save的老主库binlog内容</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]  Generating diffs succeeded.</div><div class="line">生成差异</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] Waiting until all relay logs are applied.</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]  done.</div><div class="line">这里需要等待新主库上，所有的relay log都已执行完</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] Getting slave status..</div><div class="line">在新主库上，获取从库状态，来确定它执行和读取的老主库的binlog和pos点信息</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] This slave(<span class="number">10.20.64.202</span>)'s Exec_Master_Log_Pos equals to Read_Master_Log_Pos(mysql-bin.<span class="number">0</span></div><div class="line"><span class="number">00004:120</span>). No need to recover from Exec_Master_Log_Pos.</div><div class="line">这里表示执行和读取的位置相同，也就是说，没有延迟</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] Connecting to the target slave host <span class="number">10.20.64.202</span>, running recover script..</div><div class="line">连接从库（也就是我们指定的新主库）去执行apply_diff_relay_logs脚本</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] Executing command: apply_diff_relay_logs --command=apply --slave_user='mha' --slave_host</div><div class="line">=<span class="number">10.20.64.202</span> --slave_ip=<span class="number">10.20.64.202</span>  --slave_port=<span class="number">3306</span> --apply_files=/usr/local/mha-node/apps/test/saved_master_binlog_f</div><div class="line">rom_10.<span class="number">20</span>.<span class="number">64</span>.<span class="number">204</span>_3306_20<span class="number">160407165729</span>.binlog --workdir=/usr/local/mha-node/apps/test --target_version=<span class="number">5.6.27-76</span>.<span class="number">0</span>-log --tim</div><div class="line">estamp=<span class="number">20160407165729</span> --handle_raw_binlog=<span class="number">1</span> --disable_log_bin=<span class="number">0</span> --manager_version=<span class="number">0</span>.<span class="number">56</span> --client_bindir=/usr/local/mysql/bi</div><div class="line">n --client_libdir=/usr/local/mysql/lib --slave_pass=xxx</div><div class="line">这些是ssh到node1节点，本地执行apply_diff_relay_logs脚本</div><div class="line">将老主库的pos点<span class="number">120-143</span>的binlog内容应用到新主库</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]</div><div class="line">MySQL client version is <span class="number">5</span>.<span class="number">6</span>.<span class="number">27</span>. Using --binary-mode.</div><div class="line">Applying differential binary/relay log files /usr/local/mha-node/apps/test/saved_master_binlog_from_10.<span class="number">20</span>.<span class="number">64</span>.<span class="number">204</span>_<span class="number">3306_2016</span></div><div class="line"><span class="number">0407165729</span>.binlog on <span class="number">10.20.64.202</span>:<span class="number">3306</span>. This may take long time...</div><div class="line">Applying log files succeeded.</div><div class="line">根据binlog内容的不同，这个部分可能会执行很长时间</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]  All relay logs were successfully applied.</div><div class="line">（我这里为静态测试，所以很快执行完了，且无报错）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] Getting new master's binlog name and position..</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]  mysql-bin.<span class="number">000001:120</span></div><div class="line">获取新主库的binlog和pos点信息（用来为后面自动重构主从做准备）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER</div><div class="line"> TO MASTER_HOST='<span class="number">10.20.64.202</span>', MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE='mysql-bin.<span class="number">000001</span>', MASTER_LOG_POS=<span class="number">120</span>, MASTER_USER='rep</div><div class="line">l', MASTER_PASSWORD='xxx'<span class="comment">;</span></div><div class="line">所有的从库重新change master到新主</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [warning] master_ip_failover_script is not set. Skipping taking over new master IP address.</div><div class="line">（我们没有配置master_ip_failover_script脚本，这里也跳过了接管新主ip地址的操作）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] ** Finished master recovery successfully.</div><div class="line">成功完成新主库恢复操作（主要是将老主库应用到新主库，保证数据最新）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]</div><div class="line">到此新主库接管完毕</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]</div><div class="line">第四阶段：从库恢复阶段</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] * Phase <span class="number">4</span>.<span class="number">1</span>: Starting Parallel Slave Diff Log Generation Phase..</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]</div><div class="line">第四阶段第一步：从库并行生成diff log</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] -- Slave diff file generation on host <span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>) started, pid: <span class="number">3026</span></div><div class="line">在node2上生成diff log</div><div class="line"></div><div class="line"><span class="number">2</span>. Check tmp log /usr/local/mha-manager/apps/test/<span class="number">10</span>.<span class="number">20</span>.<span class="number">64</span>.<span class="number">203</span>_3306_20<span class="number">160407165729</span>.log if it takes time..</div><div class="line"></div><div class="line"><span class="number">3</span>. Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info] -- Slave diff file generation on host <span class="number">10.20.64.210</span>(<span class="number">10.20.64.210</span>:<span class="number">3306</span>) started, pid: <span class="number">3026</span></div><div class="line">在node4上生成diff log</div><div class="line"></div><div class="line"><span class="number">3</span>. Check tmp log /usr/local/mha-manager/apps/test/<span class="number">10</span>.<span class="number">20</span>.<span class="number">64</span>.<span class="number">210</span>_3306_20<span class="number">160407165729</span>.log if it takes time..</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info]</div><div class="line">从库本地生成diff log完成</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Log messages from <span class="number">10.20.64.210</span> ...</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]  This server has all relay logs. No need to generate diff files from the latest slave.</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] End of log messages from <span class="number">10.20.64.210</span>.</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] -- <span class="number">10.20.64.210</span>(<span class="number">10.20.64.210</span>:<span class="number">3306</span>) has the latest relay log events.</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info]</div><div class="line">node4节点返回的日志信息，relay log为最新的</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Log messages from <span class="number">10.20.64.203</span> ...</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Apr  <span class="number">7 16:57:33</span> <span class="number">2016</span> - [info]  This server has all relay logs. No need to generate diff files from the latest slave.</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] End of log messages from <span class="number">10.20.64.203</span>.</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] -- <span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>) has the latest relay log events.</div><div class="line">node2节点返回的日志信息，relay log为最新的</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Generating relay diff files from the latest slave succeeded.</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info]</div><div class="line">从最新的从库生成diff log完成</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] * Phase <span class="number">4</span>.<span class="number">2</span>: Starting Parallel Slave Log Apply Phase..</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info]</div><div class="line">第四阶段第二步：从库并行应用从库日志</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] -- Slave recovery on host <span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>) started, pid: <span class="number">30266</span>. Check tmp</div><div class="line"> log /usr/local/mha-manager/apps/test/<span class="number">10</span>.<span class="number">20</span>.<span class="number">64</span>.<span class="number">203</span>_3306_20<span class="number">160407165729</span>.log if it takes time..</div><div class="line"> </div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] -- Slave recovery on host <span class="number">10.20.64.210</span>(<span class="number">10.20.64.210</span>:<span class="number">3306</span>) started, pid: <span class="number">30267</span>. Check tmp</div><div class="line"> log /usr/local/mha-manager/apps/test/<span class="number">10</span>.<span class="number">20</span>.<span class="number">64</span>.<span class="number">210</span>_3306_20<span class="number">160407165729</span>.log if it takes time..</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]</div><div class="line">分别在<span class="number">2</span>个节点进行恢复操作</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info] Log messages from <span class="number">10.20.64.203</span> ...</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Sending binlog..</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] scp from local:/usr/local/mha-manager/apps/test/saved_master_binlog_from_10.<span class="number">20.64.204_33</span></div><div class="line"><span class="number">06</span>_20<span class="number">160407165729</span>.binlog to mha@<span class="number">10.20.64.203</span>:/usr/local/mha-node/apps/test/saved_master_binlog_from_10.<span class="number">20</span>.<span class="number">64</span>.<span class="number">204</span>_<span class="number">3306_2016</span></div><div class="line"><span class="number">0407165729</span>.binlog succeeded.</div><div class="line">将老主库最后的binlog拷贝到node2节点</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Starting recovery on <span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>)..</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info]  Generating diffs succeeded.</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Waiting until all relay logs are applied.</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info]  done.</div><div class="line">在node2节点完成老主库binlog的恢复操作，如果内容比较多，恢复时间会比较长</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Getting slave status..</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] This slave(<span class="number">10.20.64.203</span>)'s Exec_Master_Log_Pos equals to Read_Master_Log_Pos(mysql-bin.<span class="number">0</span></div><div class="line"><span class="number">00004:120</span>). No need to recover from Exec_Master_Log_Pos.</div><div class="line">获取从库同步信息，查看执行和读取的老主库binlog和pos点信息</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Connecting to the target slave host <span class="number">10.20.64.203</span>, running recover script..</div><div class="line">ssh连接到node2节点，并执行apply_diff_relay_logs脚本</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Executing command: apply_diff_relay_logs --command=apply --slave_user='mha' --slave_host</div><div class="line">=<span class="number">10.20.64.203</span> --slave_ip=<span class="number">10.20.64.203</span>  --slave_port=<span class="number">3306</span> --apply_files=/usr/local/mha-node/apps/test/saved_master_binlog_f</div><div class="line">rom_10.<span class="number">20</span>.<span class="number">64</span>.<span class="number">204</span>_3306_20<span class="number">160407165729</span>.binlog --workdir=/usr/local/mha-node/apps/test --target_version=<span class="number">5.6.27-76</span>.<span class="number">0</span>-log --tim</div><div class="line">estamp=<span class="number">20160407165729</span> --handle_raw_binlog=<span class="number">1</span> --disable_log_bin=<span class="number">0</span> --manager_version=<span class="number">0</span>.<span class="number">56</span> --client_bindir=/usr/local/mysql/bi</div><div class="line">n --client_libdir=/usr/local/mysql/lib --slave_pass=xxx</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]</div><div class="line">向从库执行老主库的binlog</div><div class="line"></div><div class="line">MySQL client version is <span class="number">5</span>.<span class="number">6</span>.<span class="number">27</span>. Using --binary-mode.</div><div class="line">Applying differential binary/relay log files /usr/local/mha-node/apps/test/saved_master_binlog_from_10.<span class="number">20</span>.<span class="number">64</span>.<span class="number">204</span>_<span class="number">3306_2016</span></div><div class="line"><span class="number">0407165729</span>.binlog on <span class="number">10.20.64.203</span>:<span class="number">3306</span>. This may take long time...</div><div class="line">Applying log files succeeded.</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]  All relay logs were successfully applied.</div><div class="line">执行binlog完成，如果binlog内容多，执行时间会比较长</div><div class="line">（这时node2节点和新主的数据一致，都恢复到老主库最新的binlog点上）</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]  Resetting slave <span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>) and starting replication from the new m</div><div class="line">aster <span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>)..</div><div class="line">那么，这时可以进行reset slave操作，并建立新的主从关系</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]  Slave started.</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info] End of log messages from <span class="number">10.20.64.203</span>.</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info] -- Slave recovery on host <span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>) succeeded.</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]</div><div class="line">到此，node2节点已和新主完成主从同步</div><div class="line">（到这里，我们可以认为故障转移已完成，且非单点）</div><div class="line">下面剩余从节点操作与node2节点操作相同</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info] Log messages from <span class="number">10.20.64.210</span> ...</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Sending binlog..</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] scp from local:/usr/local/mha-manager/apps/test/saved_master_binlog_from_10.<span class="number">20.64.204_33</span></div><div class="line"><span class="number">06</span>_20<span class="number">160407165729</span>.binlog to mha@<span class="number">10.20.64.210</span>:/usr/local/mha-node/apps/test/saved_master_binlog_from_10.<span class="number">20</span>.<span class="number">64</span>.<span class="number">204</span>_<span class="number">3306_2016</span></div><div class="line"><span class="number">0407165729</span>.binlog succeeded.</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Starting recovery on <span class="number">10.20.64.210</span>(<span class="number">10.20.64.210</span>:<span class="number">3306</span>)..</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info]  Generating diffs succeeded.</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Waiting until all relay logs are applied.</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info]  done.</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Getting slave status..</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] This slave(<span class="number">10.20.64.210</span>)'s Exec_Master_Log_Pos equals to Read_Master_Log_Pos(mysql-bin.<span class="number">0</span></div><div class="line"><span class="number">00004:120</span>). No need to recover from Exec_Master_Log_Pos.</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Connecting to the target slave host <span class="number">10.20.64.210</span>, running recover script..</div><div class="line">Thu Apr  <span class="number">7 16:57:34</span> <span class="number">2016</span> - [info] Executing command: apply_diff_relay_logs --command=apply --slave_user='mha' --slave_host</div><div class="line">=<span class="number">10.20.64.210</span> --slave_ip=<span class="number">10.20.64.210</span>  --slave_port=<span class="number">3306</span> --apply_files=/usr/local/mha-node/apps/test/saved_master_binlog_f</div><div class="line">rom_10.<span class="number">20</span>.<span class="number">64</span>.<span class="number">204</span>_3306_20<span class="number">160407165729</span>.binlog --workdir=/usr/local/mha-node/apps/test --target_version=<span class="number">5.6.27-76</span>.<span class="number">0</span>-log --tim</div><div class="line">estamp=<span class="number">20160407165729</span> --handle_raw_binlog=<span class="number">1</span> --disable_log_bin=<span class="number">0</span> --manager_version=<span class="number">0</span>.<span class="number">56</span> --client_bindir=/usr/local/mysql/bi</div><div class="line">n --client_libdir=/usr/local/mysql/lib --slave_pass=xxx</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]</div><div class="line">MySQL client version is <span class="number">5</span>.<span class="number">6</span>.<span class="number">27</span>. Using --binary-mode.</div><div class="line">Applying differential binary/relay log files /usr/local/mha-node/apps/test/saved_master_binlog_from_10.<span class="number">20</span>.<span class="number">64</span>.<span class="number">204</span>_<span class="number">3306_2016</span></div><div class="line"><span class="number">0407165729</span>.binlog on <span class="number">10.20.64.210</span>:<span class="number">3306</span>. This may take long time...</div><div class="line">Applying log files succeeded.</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]  All relay logs were successfully applied.</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]  Resetting slave <span class="number">10.20.64.210</span>(<span class="number">10.20.64.210</span>:<span class="number">3306</span>) and starting replication from the new m</div><div class="line">aster <span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>)..</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]  Slave started.</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info] End of log messages from <span class="number">10.20.64.210</span>.</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info] -- Slave recovery on host <span class="number">10.20.64.210</span>(<span class="number">10.20.64.210</span>:<span class="number">3306</span>) succeeded.</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info] All new slave servers recovered successfully.</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]</div><div class="line">到此，新架构完成，所有从节点已与新主建立主从同步</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]</div><div class="line">第四阶段：新主库清理工作</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info] Resetting slave info on the new master..</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]  <span class="number">10.20.64.202</span>: Resetting slave info succeeded.</div><div class="line">node1已经是主库身份，那么它不再隶属于谁，所以进行reset slave操作，清理同步信息</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info] Master failover to <span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>) completed successfully.</div><div class="line">到此，故障转移成功完成</div><div class="line"></div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info] Deleted server1 entry from /usr/local/mha-manager/etc/test2.conf .</div><div class="line">Thu Apr  <span class="number">7 16:57:35</span> <span class="number">2016</span> - [info]</div><div class="line">清理配置文件中老主库信息，我们可以使用这个配置文件，再次启动masterha_manager脚本</div><div class="line"></div><div class="line">----- Failover Report -----</div><div class="line">这里会总结一个故障转移报告</div><div class="line"></div><div class="line">test2: MySQL Master failover <span class="number">10.20.64.204</span>(<span class="number">10.20.64.204</span>:<span class="number">3306</span>) to <span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>) succeeded</div><div class="line">test2应用成功将<span class="number">204</span>故障转移到<span class="number">202</span></div><div class="line"></div><div class="line">Master <span class="number">10.20.64.204</span>(<span class="number">10.20.64.204</span>:<span class="number">3306</span>) is down!</div><div class="line">老主库<span class="number">204:3306</span>实例宕掉</div><div class="line"></div><div class="line">Check MHA Manager logs at n-op-<span class="number">209</span>.corp.ncfgroup.com:/usr/local/mha-manager/logs/test.log for details.</div><div class="line">切换日志路径</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">The latest slave <span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>) has all relay logs for recovery.</div><div class="line"><span class="number">203</span>是最近的实例</div><div class="line"></div><div class="line">Selected <span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>) as a new master.</div><div class="line">选择<span class="number">202</span>作为新主（这个是我们用选项指定的）</div><div class="line"></div><div class="line"><span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>): OK: Applying all logs succeeded.</div><div class="line">老主库的binlog已成功应用于所有实例</div><div class="line"></div><div class="line"><span class="number">10.20.64.210</span>(<span class="number">10.20.64.210</span>:<span class="number">3306</span>): This host has the latest relay log events.</div><div class="line"><span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>): This host has the latest relay log events.</div><div class="line"><span class="number">210和203</span>的relay log都是最新的事件</div><div class="line"></div><div class="line">Generating relay diff files from the latest slave succeeded.</div><div class="line">从最近的从节点获取relay log的diff成功</div><div class="line"></div><div class="line"><span class="number">10.20.64.203</span>(<span class="number">10.20.64.203</span>:<span class="number">3306</span>): OK: Applying all logs succeeded. Slave started, replicating from <span class="number">10.20.64.202</span>(<span class="number">10.20.64.20</span></div><div class="line"><span class="number">2</span>:<span class="number">3306</span>)</div><div class="line">node2将与新主node4的relay log的差异执行完成</div><div class="line"></div><div class="line"><span class="number">10.20.64.210</span>(<span class="number">10.20.64.210</span>:<span class="number">3306</span>): OK: Applying all logs succeeded. Slave started, replicating from <span class="number">10.20.64.202</span>(<span class="number">10.20.64.20</span></div><div class="line"><span class="number">2</span>:<span class="number">3306</span>)</div><div class="line">node5将与新主node4的relay log的差异执行完成</div><div class="line"></div><div class="line">分别在从库执行diff relay log的内容，将数据补齐，并与新主建立主从同步</div><div class="line"></div><div class="line"><span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>): Resetting slave info succeeded.</div><div class="line">Master failover to <span class="number">10.20.64.202</span>(<span class="number">10.20.64.202</span>:<span class="number">3306</span>) completed successfully.</div><div class="line">新主清理与老主同步关系</div><div class="line">到此，故障转移成功完成</div></pre></td></tr></table></figure>
<p>我们分别到mha-node和mha-manager的工作目录看看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/mha-node/apps/<span class="built_in">test</span></div><div class="line">/usr/<span class="built_in">local</span>/mha-manager/apps/<span class="built_in">test</span></div></pre></td></tr></table></figure>
<p>mha-node</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">老主库</div><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">mha</span> <span class="selector-tag">mysql</span>  143 4月   7 16<span class="selector-pseudo">:57</span> <span class="selector-tag">saved_master_binlog_from_10</span><span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.204_3306_20160407165729</span><span class="selector-class">.binlog</span></div><div class="line"></div><div class="line">新主库</div><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">mha</span> <span class="selector-tag">mysql</span>  143 4月   7 16<span class="selector-pseudo">:57</span> <span class="selector-tag">saved_master_binlog_from_10</span><span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.204_3306_20160407165729</span><span class="selector-class">.binlog</span></div><div class="line"></div><div class="line">剩余2从库抽样</div><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">mha</span> <span class="selector-tag">mysql</span>  143 4月   7 16<span class="selector-pseudo">:57</span> <span class="selector-tag">saved_master_binlog_from_10</span><span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.204_3306_20160407165729</span><span class="selector-class">.binlog</span></div><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">mha</span> <span class="selector-tag">mysql</span> 1096 4月   7 16<span class="selector-pseudo">:57</span> <span class="selector-tag">relay_log_apply_for_10</span><span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.210_3306_20160407165729_err</span><span class="selector-class">.log</span></div></pre></td></tr></table></figure>
<p>mha-manager</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">mha</span> <span class="selector-tag">mysql</span> 143 4月   7 16<span class="selector-pseudo">:57</span> <span class="selector-tag">saved_master_binlog_from_10</span><span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.204_3306_20160407165729</span><span class="selector-class">.binlog</span></div><div class="line"><span class="selector-tag">-rw-r--r--</span> 1 <span class="selector-tag">mha</span> <span class="selector-tag">mysql</span>   0 4月   7 16<span class="selector-pseudo">:57</span> <span class="selector-tag">test2</span><span class="selector-class">.failover</span><span class="selector-class">.complete</span></div></pre></td></tr></table></figure>
<p>配置文件</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[mha@n-op<span class="number">-209</span> etc]$ cat test2.conf</div><div class="line">[server <span class="section">default</span>]</div><div class="line">...</div><div class="line"></div><div class="line">这里，老主库的[server1]块被清除了</div><div class="line"></div><div class="line">[server2]</div><div class="line">candidate_master=<span class="number">1</span></div><div class="line">hostname=<span class="number">10.20</span><span class="number">.64</span><span class="number">.203</span></div><div class="line">node_label=test standby</div><div class="line"></div><div class="line">[server3]</div><div class="line">candidate_master=<span class="number">1</span></div><div class="line">hostname=<span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span></div><div class="line">node_label=test standby</div><div class="line"></div><div class="line">[server4]</div><div class="line">hostname=<span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span></div><div class="line">no_master=<span class="number">1</span></div><div class="line">node_label=test slave</div></pre></td></tr></table></figure>
<p><strong>结论：MHA会产生脑裂，目前都是HA，所以DBA处理好写指向问题</strong></p>
<p><em>另外，从MySQL本身来说，可以结合Semisynchronous Replication半同步，应该是一个不错的选择</em></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://mckobe23.github.io/2016/04/06/mha-master-switch/" data-id="cirom3y0g000hggfy8zqsxqwp" class="article-share-link">Share</a><div class="tags"><a href="/tags/mysql/">mysql</a><a href="/tags/mha/">mha</a></div><div class="post-nav"><a href="/2016/05/10/engine-innodb/" class="pre">MySQL存储引擎InnoDB</a><a href="/2016/04/01/semi-sync/" class="next">MySQL半同步注意事项</a></div><div id="disqus_thread"><script>var disqus_shortname = 'mckobe23';
var disqus_identifier = '2016/04/06/mha-master-switch/';
var disqus_title = 'MHA故障转移之masterha_master_switch';
var disqus_url = 'http://mckobe23.github.io/2016/04/06/mha-master-switch/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mckobe23.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://mckobe23.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/mongodb/">mongodb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/mongodb/" style="font-size: 15px;">mongodb</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/auto-increment/" style="font-size: 15px;">auto increment</a> <a href="/tags/mha/" style="font-size: 15px;">mha</a> <a href="/tags/myisam/" style="font-size: 15px;">myisam</a> <a href="/tags/innodb/" style="font-size: 15px;">innodb</a> <a href="/tags/tokudb/" style="font-size: 15px;">tokudb</a> <a href="/tags/replace-into/" style="font-size: 15px;">replace into</a> <a href="/tags/osc/" style="font-size: 15px;">osc</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/semi-sync/" style="font-size: 15px;">semi-sync</a> <a href="/tags/sqlserver/" style="font-size: 15px;">sqlserver</a> <a href="/tags/oracle/" style="font-size: 15px;">oracle</a> <a href="/tags/update/" style="font-size: 15px;">update</a> <a href="/tags/utf8mb4/" style="font-size: 15px;">utf8mb4</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/08/10/redis-info-output-format/">Redis INFO输出文本后的编码问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/28/autoincrment-conflict/">自增主键同步差异后的故障切换，自增主键冲突</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/22/replace-autoincrement/">Replace into 带来的主从自增主键差异</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/07/mongodb-deploy/">MongoDB部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/06/redis-deploy/">Redis部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/30/update-snytax/">UPDATE SYNTAX</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/23/osc/">pt-osc工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/10/engine-innodb/">MySQL存储引擎InnoDB</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/06/mha-master-switch/">MHA故障转移之masterha_master_switch</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/01/semi-sync/">MySQL半同步注意事项</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//mckobe23.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://hbprotoss.github.io" title="hbprotoss的博客" target="_blank">hbprotoss的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">喀秋莎的技术博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>