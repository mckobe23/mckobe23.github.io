<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="快乐每一天 夏虫不可以语冰"><title>MHA检测之masterha_check_ssh | 喀秋莎的技术博客</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">MHA检测之masterha_check_ssh</h1><a id="logo" href="/.">喀秋莎的技术博客</a><p class="description">快乐每一天 夏虫不可以语冰</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">MHA检测之masterha_check_ssh</h1><div class="post-meta">Mar 22, 2016<span> | </span><span class="category"><a href="/categories/mysql/">mysql</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/03/22/mha-check-ssh/" href="/2016/03/22/mha-check-ssh/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h3 id="MHA有两个重要的检测工具，分别用来验证节点间主机通讯和主从关系健康情况"><a href="#MHA有两个重要的检测工具，分别用来验证节点间主机通讯和主从关系健康情况" class="headerlink" title="MHA有两个重要的检测工具，分别用来验证节点间主机通讯和主从关系健康情况"></a>MHA有两个重要的检测工具，分别用来验证节点间主机通讯和主从关系健康情况</h3><p><strong>masterha_check_ssh</strong><br>负责检测ssh通讯是否正常，并且会在masterha_manager和masterha_check_repl脚本启动的时候，被调用</p>
<p>Manager访问节点实例，需要通过ssh<br>Node从库节点间拷贝relay log，需要通过ssh<br>（这也就是为什么我们在安装时需要建立主机之间的信任关系）</p>
<p><strong>环境</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">manager</span> 10<span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.209</span></div><div class="line"><span class="selector-tag">node1</span>	10<span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.202</span></div><div class="line"><span class="selector-tag">node2</span>	10<span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.203</span></div><div class="line"><span class="selector-tag">node3</span>	10<span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.204</span></div><div class="line"><span class="selector-tag">node4</span>	10<span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.210</span></div></pre></td></tr></table></figure>
<p>这里我们使用了1主3从，共4个节点。网上很多是按3个节点来的，而实际的工作中，我们很可能为了负载读，会建立n个从库，那么就来的真实一点，看看超过3个节点的时候，MHA是如何工作的</p>
<p>PS：并且我们将Manager单分出去，也不同于官方或者网上选择某一个节点兼职Manager。也算规划的一部分吧，我们可以在这台Manager上面管理n组集群（当然，你也可以为它做HA）</p>
<p><strong>ssh检测</strong></p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">[mha@n-op-<span class="number">209</span> etc]$ masterha_check_ssh --conf=/usr/local/mha-manager/etc/<span class="keyword">test</span>.conf</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">32</span> <span class="number">2016</span> - [warning] <span class="meta">Global</span> configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</div><div class="line">这里感觉mha不像mysql那么聪明，虽然我们已经手动指定了conf文件的绝对路径，但它还是会去/etc下找默认的配置文件。忽略即可</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">32</span> <span class="number">2016</span> - [info] Reading application <span class="meta">default</span> configuration from /usr/local/mha-manager/etc/<span class="keyword">test</span>.conf..</div><div class="line">这里它读取配置文件的[<span class="meta">default</span>]内容</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">32</span> <span class="number">2016</span> - [info] Reading server configuration from /usr/local/mha-manager/etc/<span class="keyword">test</span>.conf..</div><div class="line">这里它读取配置文件的[server]内容</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">32</span> <span class="number">2016</span> - [info] Starting SSH connection tests..</div><div class="line">这里开始了排列组合式的ssh检测，我们有<span class="number">4</span>个节点，那么就是n*(n-<span class="number">1</span>)次检测，这里是<span class="number">12</span>次</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">32</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">32</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">（node1到node2）</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">32</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">（node1到node3）</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">（node1到node4）</div><div class="line"></div><div class="line">－－－</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">34</span> <span class="number">2016</span> - [debug]</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">（node2到node1）</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">（node2到node3）</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">（node2到node4）</div><div class="line"></div><div class="line">－－－</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">34</span> <span class="number">2016</span> - [debug]</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">（node3到node1）</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">33</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">34</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">（node3到node2）</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">34</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">34</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">（node3到node4）</div><div class="line"></div><div class="line">－－－</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">35</span> <span class="number">2016</span> - [debug]</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">34</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">34</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">（node4到node1）</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">34</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">34</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">（node4到node2）</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">34</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">34</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">（node4到node3）</div><div class="line"></div><div class="line">Wed Mar <span class="number">23</span> <span class="number">15</span>:<span class="number">06</span>:<span class="number">35</span> <span class="number">2016</span> - [info] All SSH connection tests passed successfully.</div><div class="line">ssh连接检测成功</div><div class="line">至此检测完毕</div></pre></td></tr></table></figure>
<p>下面我们破坏node2的信任，再来看看ssh_check是如何工作的</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@n-op-203 .ssh]<span class="comment"># pwd</span></div><div class="line">/home/mha/.ssh</div><div class="line"></div><div class="line">[root@n-op-203 .ssh]<span class="comment"># ll</span></div><div class="line">总用量 20</div><div class="line">-rw-------<span class="number"> 1 </span>mha mysql<span class="number"> 1648 </span>3月 <span class="number"> 23 </span>14:30 authorized_keys</div><div class="line">-rw-r--r--<span class="number"> 1 </span>mha mysql <span class="number"> 152 </span>3月 <span class="number"> 14 </span>15:06 environment</div><div class="line">-rw-------<span class="number"> 1 </span>mha mysql<span class="number"> 1675 </span>12月<span class="number"> 25 </span>18:08 id_rsa</div><div class="line">-rw-r--r--<span class="number"> 1 </span>mha mysql <span class="number"> 412 </span>12月<span class="number"> 25 </span>18:08 id_rsa.pub</div><div class="line">-rw-r--r--<span class="number"> 1 </span>mha mysql<span class="number"> 1182 </span>12月<span class="number"> 29 </span>16:06 known_hosts</div><div class="line"></div><div class="line">这是已有的信任</div><div class="line">[root@n-op-203 .ssh]<span class="comment"># cat authorized_keys</span></div><div class="line"></div><div class="line">ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAzMXm1ZwC/T9eFZJSFhMHzv0RcGX+KNC+kHmOCRlW6hpOGUs4scBR4ulz7G4TgZjl0HYkydnnHlF4DHmfq7STc4Kuf+xXX1qAiZNdRTyNVe/4atBtjPtL3SYsbmbZwqU6M5q7ssg1ZNMZ26Vnh7UVA0JsYxJIGF73lWVs0lqjUxbOGZ6SBlMzFi4NH82MMxjC/JidmTpDoVQhmzZ7TM+Lc7Gs3eTsv/9/cIgaU2sPTt6u4GgM/1FNFT67VsoQQ+yyZ2tTXLSfrIR2UYNtAGafoWvDWwrMBPWpzPjqTp7fAX3qtr3dEk53uXgsi87jjpjXsWM9bK092HUwistFyL2nUw== mha@n-op-202.corp.com</div><div class="line">ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAp6IGTW+geUV8l2DyThO3WkhA7oKtOtCfaSpoqLHbOCj2BHntX4opDC4zMkGjnKgUH4lE6K+VkkdkTJJvIqJXVFn6xFI0Vd6wLPKiCddvp1KnJb3Eqg/KdwxWzV+q5ReHU6N9J/B5eeRNnyJwhTqG0TuMUhoVVkS80lV4qiS2OpRPv2bohothMnufjlteeJGHqzgt84DTD2QUUYlfXwEv8V8o02pPR2s+vLOvXEv+LCzjOexFknkHmo2/DNhzHqG1QYHgmR/ku2WpJAnFZ3yRVzdahjq/pRKJ87XhN6ZZvNOuLHLuStYvlbq4pGuSUCIJmzn2slbRaVSQKMuuNgHy/Q== mha@n-op-203.corp.com</div><div class="line">ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEApW6fLJU0HecKi6mz5dYDg2xvGM5QjiNlFEL3PjgOwS9EShfWIDRuDnk1hybCpaWKdfp66DX6iVNDmdfDoQ7Oz+j+pxu9itetKn6eoKNJBsxKtw+LOkxqw+LE/o4iRM77BWDyLtrXGrKpAebK3DZn//d7RiKd8Can+/LJRsTAnYCHj+NPLsd3ELiDnsn/fJfJU81nYk5oPwMVpKepRXu02tLzOyy1Vw7K4mINnSDEMh+vG3iPna/xIS33oea3WIOwC8SFkZ38hzNCHpa85bvSoc5fU0vu0xyOV0irEO+jqGjBEqqcQ+Lg5zRDpkz+Ma1YtVIuR2rwu0kbLTRLrBHGjw== mha@n-op-204.corp.com</div><div class="line">ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAz+F+j1oehUpbDV9pNogjcHmZZQl0mJsp4pR+pixxnT4/dZGsqxzPzb1CJlxe1OFtPOk6+oD3yQ1kQfTtTmnyqhcZ+06F0stQtaOEc1aYaMGuFVNhvZK0S4JUtJ6liAJb9tQxPdtp1eNHKUBBIDreEM036U1lD/qbDlqRuSLM7DGzlRILu7dKQE3xiAb1VuQg9t/gejjiziivSQ2KVqF33T5wmFE+FSp5rHyArTS8NUCA4LIZmA0OSWykOLh4t5QxFne7kvzOM9zCCSNe+p1YmtuQBIDom5mH9hKouZGciZFWdeBAynAATYjCPPbDBSY30jlWfIkmsZ7wX8UPIyiAmQ== mha@n-op-209.corp.com</div><div class="line">ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAoWNfSuCiRcR4TUYi1m9Pqpd6v76/jvs+jX8MTgTRIjgz3JeKJ/NpQKJ7GeBSaEmKAg0b8iTNR61fOlV7WMLKo6YRWsuYwD5dIk/wFAZs1gYYsLcU9Dslbqnbz94EMz324sbNZm+05aVfPG0VEEGxjsSKgsl7JogQfk6rq+19cxPizsdBsdo4ZEI0ahbPkzRl4FvvN5NXZZ6sLhH1XmbcJxtGE9cNJiaxTEZe2Nexhfv+MBatDZSSosbHt+MvjwsNfngilSIe6C/fCcVdsdEoLt4B4ZOEbmyLhudnvMTMWWJrbMZzE2AHqIcjl3ctr4rJgPP7f7FEUxvlmVO694/HWQ== mha@n-op-210.corp.com</div><div class="line"></div><div class="line">将其重命名</div><div class="line">[root@n-op-203 .ssh]<span class="comment"># mv authorized_keys authorized_keys.bak</span></div></pre></td></tr></table></figure>
<p>再次check_ssh</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">[mha@n-op-209 etc]$ masterha<span class="emphasis">_check_</span>ssh --conf=/usr/local/mha-manager/etc/test.conf</div><div class="line"></div><div class="line">Wed Mar 23 15:09:56 2016 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</div><div class="line">Wed Mar 23 15:09:56 2016 - [info] Reading application default configuration from /usr/local/mha-manager/etc/test.conf..</div><div class="line">Wed Mar 23 15:09:56 2016 - [info] Reading server configuration from /usr/local/mha-manager/etc/test.conf..</div><div class="line"></div><div class="line">Wed Mar 23 15:09:56 2016 - [info] Starting SSH connection tests..</div><div class="line">这里开始了排列组合式的ssh检测，我们有4个节点，那么就是n*(n-1)次检测，这里是12次</div><div class="line"></div><div class="line">Wed Mar 23 15:09:56 2016 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/SSHCheck.pm, ln63</span>]</div><div class="line">Wed Mar 23 15:09:56 2016 - [debug]  Connecting via SSH from mha@10.20.64.202(10.20.64.202:22) to mha@10.20.64.203(10.20.64.203:22)..</div><div class="line">Permission denied (publickey,password).</div><div class="line">（node1到node2没有权限）</div><div class="line"></div><div class="line">Wed Mar 23 15:09:56 2016 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/SSHCheck.pm, ln111</span>] SSH connection from mha@10.20.64.202(10.20.64.202:22) to mha@10.20.64.203(10.20.64.203:22) failed!</div><div class="line">（node1到node2连接失败！）</div><div class="line"></div><div class="line">注意：这里并没有检测node1到node3，也没有检测node1到node4，直接进入node2检测其他节点阶段</div><div class="line">也就是说：当出现异常后，放弃该节点对剩余节点的所有检测，进入下一个节点连接检测</div><div class="line"></div><div class="line">－－－</div><div class="line">Wed Mar 23 15:09:57 2016 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/SSHCheck.pm, ln63</span>]</div><div class="line">Wed Mar 23 15:09:56 2016 - [debug]  Connecting via SSH from mha@10.20.64.203(10.20.64.203:22) to mha@10.20.64.202(10.20.64.202:22)..</div><div class="line">Permission denied (publickey,password).</div><div class="line">（node2到node1没有权限）</div><div class="line"></div><div class="line">Wed Mar 23 15:09:56 2016 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/SSHCheck.pm, ln111</span>] SSH connection from mha@10.20.64.203(10.20.64.203:22) to mha@10.20.64.202(10.20.64.202:22) failed!</div><div class="line">（node2到node3连接失败！）</div><div class="line"></div><div class="line">－－－</div><div class="line">Wed Mar 23 15:09:57 2016 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/SSHCheck.pm, ln63</span>]</div><div class="line">下面成功了为什么还会报错？</div><div class="line"></div><div class="line">Wed Mar 23 15:09:57 2016 - [debug]  Connecting via SSH from mha@10.20.64.204(10.20.64.204:22) to mha@10.20.64.202(10.20.64.202:22)..</div><div class="line">Wed Mar 23 15:09:57 2016 - [debug]   ok.</div><div class="line">（这里是第一次成功的：node3到node1）</div><div class="line"></div><div class="line">所以上面那句报错，应该是属于这里的（我补：Wed Mar 23 15:09:57 2016 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/SSHCheck.pm, ln63</span>]）</div><div class="line">Wed Mar 23 15:09:57 2016 - [debug]  Connecting via SSH from mha@10.20.64.204(10.20.64.204:22) to mha@10.20.64.203(10.20.64.203:22)..</div><div class="line">Permission denied (publickey,password).</div><div class="line">（node3到node2没有权限）</div><div class="line"></div><div class="line">Wed Mar 23 15:09:57 2016 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/SSHCheck.pm, ln111</span>] SSH connection from mha@10.20.64.204(10.20.64.204:22) to mha@10.20.64.203(10.20.64.203:22) failed!</div><div class="line">（node3到node2连接失败！）</div><div class="line"></div><div class="line">－－－</div><div class="line">Wed Mar 23 15:09:58 2016 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/SSHCheck.pm, ln63</span>]</div><div class="line">下面成功了为什么还会报错？</div><div class="line"></div><div class="line">Wed Mar 23 15:09:57 2016 - [debug]  Connecting via SSH from mha@10.20.64.210(10.20.64.210:22) to mha@10.20.64.202(10.20.64.202:22)..</div><div class="line">Wed Mar 23 15:09:57 2016 - [debug]   ok.</div><div class="line">（这里是第二次成功的：node4到node1）</div><div class="line"></div><div class="line">所以上面那句报错，应该是属于这里的（我补：Wed Mar 23 15:09:58 2016 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/SSHCheck.pm, ln63</span>]）</div><div class="line">Wed Mar 23 15:09:57 2016 - [debug]  Connecting via SSH from mha@10.20.64.210(10.20.64.210:22) to mha@10.20.64.203(10.20.64.203:22)..</div><div class="line">Permission denied (publickey,password).</div><div class="line">（node4到node2没有权限）</div><div class="line"></div><div class="line">Wed Mar 23 15:09:58 2016 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/SSHCheck.pm, ln111</span>] SSH connection from mha@10.20.64.210(10.20.64.210:22) to mha@10.20.64.203(10.20.64.203:22) failed!</div><div class="line">（node4到node2连接失败！）</div><div class="line"></div><div class="line">semi-panic: attempt to dup freed string at /usr/local/share/perl5/Carp.pm line 229.</div><div class="line">SSH Configuration Check Failed!</div><div class="line"> at /usr/local/mha-manager/bin/masterha<span class="emphasis">_check_</span>ssh line 44.</div><div class="line">ssh连接检测失败！</div><div class="line">到此检测完毕</div></pre></td></tr></table></figure>
<p>可以看到ssh检测是分两段式返回的</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">SSHCheck<span class="selector-class">.pm</span>, ln63:	Permission denied (publickey,password).</div><div class="line">SSHCheck<span class="selector-class">.pm</span>, ln111:	SSH connection from X to Y failed!</div></pre></td></tr></table></figure>
<h4 id="我们来看看SSHCheck-pm-ln63和ln111在干嘛"><a href="#我们来看看SSHCheck-pm-ln63和ln111在干嘛" class="headerlink" title="我们来看看SSHCheck.pm, ln63和ln111在干嘛"></a>我们来看看SSHCheck.pm, ln63和ln111在干嘛</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">  <span class="number">1</span> <span class="comment">#!/usr/bin/env perl</span></div><div class="line">  ...</div><div class="line"> <span class="number">31</span> <span class="keyword">use</span> Parallel::ForkManager;</div><div class="line">  ...</div><div class="line"> <span class="number">47</span>   <span class="keyword">my</span> $pm     = new Parallel::ForkManager( $#servers + <span class="number">1</span> );</div><div class="line">  ...</div><div class="line"> <span class="number">55</span>   $pm-&gt;run_on_finish(</div><div class="line"> <span class="number">56</span>     <span class="function"><span class="keyword">sub</span> </span>&#123;</div><div class="line"> <span class="number">57</span>       <span class="keyword">my</span> ( $pid, $exit_code, $target ) = @_;</div><div class="line"> <span class="number">58</span>       <span class="keyword">return</span> <span class="keyword">if</span> ( $target-&gt;&#123;skip_init_ssh_check&#125; );</div><div class="line"> <span class="number">59</span>       <span class="keyword">my</span> $local_file =</div><div class="line"> <span class="number">60</span>         <span class="string">"$workdir/$target-&gt;&#123;ssh_host&#125;_$target-&gt;&#123;ssh_port&#125;_ssh_check.log"</span>;</div><div class="line"> <span class="number">61</span>       <span class="keyword">if</span> ($exit_code) &#123;</div><div class="line"> <span class="number">62</span>         $failed = <span class="number">1</span>;</div><div class="line"> <span class="number">63</span>         <span class="keyword">if</span> ( -f $local_file ) &#123;</div><div class="line"> <span class="number">64</span>           $log-&gt;error( <span class="string">"\n"</span> . <span class="string">`cat $local_file`</span> );</div><div class="line"> <span class="number">65</span>         &#125;</div><div class="line"> <span class="number">66</span>       &#125;</div><div class="line"> <span class="number">67</span>       <span class="keyword">else</span> &#123;</div><div class="line"> <span class="number">68</span>         <span class="keyword">if</span> ( -f $local_file ) &#123;</div><div class="line"> <span class="number">69</span>           $log-&gt;debug( <span class="string">"\n"</span> . <span class="string">`cat $local_file`</span> );</div><div class="line"> <span class="number">70</span>         &#125;</div><div class="line"> <span class="number">71</span>       &#125;</div><div class="line"> <span class="number">72</span>       <span class="keyword">unlink</span> $local_file;</div><div class="line"> <span class="number">73</span>     &#125;</div><div class="line"> <span class="number">74</span>   );</div><div class="line"> .</div><div class="line"><span class="number">101</span>       <span class="keyword">foreach</span> <span class="keyword">my</span> $dst (@servers) &#123;</div><div class="line"><span class="number">102</span>         <span class="keyword">next</span> <span class="keyword">if</span> ( $dst-&gt;&#123;skip_init_ssh_check&#125; );</div><div class="line"><span class="number">103</span>         <span class="keyword">next</span> <span class="keyword">if</span> ( $src-&gt;&#123;id&#125; eq $dst-&gt;&#123;id&#125; );</div><div class="line"><span class="number">104</span>         $pplog-&gt;debug(</div><div class="line"><span class="number">105</span> <span class="string">" Connecting via SSH from $src-&gt;&#123;ssh_user&#125;\@$src-&gt;&#123;ssh_host&#125;($src-&gt;&#123;ssh_ip&#125;:$src-&gt;&#123;ssh_port&#125;) to $dst-&gt;&#123;ssh_user&#125;\@$ds    t-&gt;&#123;ssh_host&#125;($dst-&gt;&#123;ssh_ip&#125;:$dst-&gt;&#123;ssh_port&#125;).."</span></div><div class="line"><span class="number">106</span>         );</div><div class="line"><span class="number">107</span>         <span class="keyword">my</span> $command =</div><div class="line"><span class="number">108</span> <span class="string">"ssh $MHA::ManagerConst::SSH_OPT_CHECK -p $src-&gt;&#123;ssh_port&#125; $src-&gt;&#123;ssh_user&#125;\@$src-&gt;&#123;ssh_ip&#125; \"ssh $MHA::ManagerConst::    SSH_OPT_CHECK -p $dst-&gt;&#123;ssh_port&#125; $dst-&gt;&#123;ssh_user&#125;\@$dst-&gt;&#123;ssh_ip&#125; exit 0\""</span>;</div><div class="line"><span class="number">109</span>         <span class="keyword">my</span> ( $high, $low ) = MHA::ManagerUtil::exec_system( $command, $file );</div><div class="line"><span class="number">110</span>         <span class="keyword">if</span> ( $high != <span class="number">0</span> || $low != <span class="number">0</span> ) &#123;</div><div class="line"><span class="number">111</span>           $pplog-&gt;error(</div><div class="line"><span class="number">112</span> <span class="string">"SSH connection from $src-&gt;&#123;ssh_user&#125;\@$src-&gt;&#123;ssh_host&#125;($src-&gt;&#123;ssh_ip&#125;:$src-&gt;&#123;ssh_port&#125;) to $dst-&gt;&#123;ssh_user&#125;\@$dst-&gt;&#123;s    sh_host&#125;($dst-&gt;&#123;ssh_ip&#125;:$dst-&gt;&#123;ssh_port&#125;) failed!"</span></div><div class="line"><span class="number">113</span>           );</div><div class="line"><span class="number">114</span>           $pm-&gt;finish(<span class="number">1</span>);</div><div class="line"><span class="number">115</span>         &#125;</div><div class="line"><span class="number">116</span>         $pplog-&gt;debug(<span class="string">"  ok."</span>);</div><div class="line"><span class="number">117</span>       &#125;</div><div class="line"><span class="number">118</span>       $pm-&gt;finish(<span class="number">0</span>);</div><div class="line"><span class="number">119</span>     &#125;;</div></pre></td></tr></table></figure>
<p>Parallel::ForkManager 这个模块是通过 Fork 进程而不是创建线程来实现并行处理</p>
<p>拼手速的时候到了，你也可以写个脚本监控下进程和中间输出</p>
<p>既然是fork进程，那我们就能抓取到</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@n-op-<span class="number">209</span> MHA]# <span class="keyword">ps</span> -ef|<span class="keyword">grep</span> check</div><div class="line">mha      <span class="number">11149</span> <span class="number">10757</span> <span class="number">19</span> <span class="number">16</span>:<span class="number">15</span> <span class="keyword">pts</span>/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="keyword">perl</span> /usr/local/mha-manager/bin/masterha_check_ssh --<span class="keyword">conf</span>=/usr/local/mha-manager/etc/test.<span class="keyword">conf</span></div><div class="line"></div><div class="line">mha      <span class="number">11170</span> <span class="number">11149</span>  <span class="number">0</span> <span class="number">16</span>:<span class="number">15</span> <span class="keyword">pts</span>/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="keyword">perl</span> /usr/local/mha-manager/bin/masterha_check_ssh --<span class="keyword">conf</span>=/usr/local/mha-manager/etc/test.<span class="keyword">conf</span></div><div class="line"></div><div class="line">mha      <span class="number">11171</span> <span class="number">11170</span>  <span class="number">0</span> <span class="number">16</span>:<span class="number">15</span> <span class="keyword">pts</span>/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="keyword">sh</span> -<span class="keyword">c</span> ssh -<span class="keyword">o</span> StrictHostKeyChecking=<span class="keyword">no</span> -<span class="keyword">o</span> PasswordAuthentication=<span class="keyword">no</span> -<span class="keyword">o</span> BatchMode=yes -<span class="keyword">o</span> ConnectTimeout=<span class="number">5</span> -<span class="keyword">p</span> <span class="number">22</span> mha@<span class="number">10.20</span>.<span class="number">64.210</span> <span class="string">"ssh -o StrictHostKeyChecking=no -o PasswordAuthentication=no -o BatchMode=yes -o ConnectTimeout=5 -p 22 mha@10.20.64.202 exit 0"</span> &gt;&gt; /tmp/<span class="number">10.20</span>.<span class="number">64.210</span>_22_ssh_check.<span class="built_in">log</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line">[root@n-op-<span class="number">209</span> MHA]# <span class="keyword">ps</span> -ef|<span class="keyword">grep</span> check</div><div class="line">mha      <span class="number">11149</span> <span class="number">10757</span>  <span class="number">9</span> <span class="number">16</span>:<span class="number">15</span> <span class="keyword">pts</span>/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="keyword">perl</span> /usr/local/mha-manager/bin/masterha_check_ssh --<span class="keyword">conf</span>=/usr/local/mha-manager/etc/test.<span class="keyword">conf</span></div><div class="line"></div><div class="line">mha      <span class="number">11170</span> <span class="number">11149</span>  <span class="number">0</span> <span class="number">16</span>:<span class="number">15</span> <span class="keyword">pts</span>/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="keyword">perl</span> /usr/local/mha-manager/bin/masterha_check_ssh --<span class="keyword">conf</span>=/usr/local/mha-manager/etc/test.<span class="keyword">conf</span></div><div class="line"></div><div class="line">mha      <span class="number">11175</span> <span class="number">11170</span>  <span class="number">0</span> <span class="number">16</span>:<span class="number">15</span> <span class="keyword">pts</span>/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="keyword">sh</span> -<span class="keyword">c</span> ssh -<span class="keyword">o</span> StrictHostKeyChecking=<span class="keyword">no</span> -<span class="keyword">o</span> PasswordAuthentication=<span class="keyword">no</span> -<span class="keyword">o</span> BatchMode=yes -<span class="keyword">o</span> ConnectTimeout=<span class="number">5</span> -<span class="keyword">p</span> <span class="number">22</span> mha@<span class="number">10.20</span>.<span class="number">64.210</span> <span class="string">"ssh -o StrictHostKeyChecking=no -o PasswordAuthentication=no -o BatchMode=yes -o ConnectTimeout=5 -p 22 mha@10.20.64.203 exit 0"</span> &gt;&gt; /tmp/<span class="number">10.20</span>.<span class="number">64.210</span>_22_ssh_check.<span class="built_in">log</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></div></pre></td></tr></table></figure>
<p><strong>11149 是 masterha_check_ssh</strong><br><strong>11170 就是 11149的fork进程</strong><br><strong>11171和11175 都是 由11170再fork出来实际干活的</strong></p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>StrictHostKeyChecking=no</td>
<td>SSH对主机的public_key的检查等级，那么连接主机时不会看到任何提示</td>
</tr>
<tr>
<td>PasswordAuthentication=no</td>
<td>无需鉴定密码</td>
</tr>
<tr>
<td>BatchMode=yes</td>
<td>连接中不跳出输入密码提示，连接不成功自动定义为连接失败</td>
</tr>
<tr>
<td>ConnectTimeout=5</td>
<td>连接超时5秒</td>
</tr>
<tr>
<td>&gt;&gt; /tmp/10.20.64.210_22_ssh_check.log 2&gt;&amp;1</td>
<td>将标准输出和错误输出，都写入临时日志文件</td>
</tr>
</tbody>
</table>
<p>日志抽样</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@n-op-<span class="number">209</span> tmp]# cat /tmp/<span class="number">10.20</span><span class="meta">.64</span>.210_22_ssh_check.log</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">56</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>:<span class="number">22</span>)..</div><div class="line">[root@n-op-<span class="number">209</span> tmp]# cat /tmp/<span class="number">10.20</span><span class="meta">.64</span>.210_22_ssh_check.log</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">56</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>:<span class="number">22</span>)..</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">57</span> <span class="number">2016</span> - [debug]   ok.</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">57</span> <span class="number">2016</span> - [debug]  Connecting via SSH from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>:<span class="number">22</span>)..</div><div class="line">Permission denied (publickey,password).</div><div class="line">Wed Mar <span class="number">23</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">57</span> <span class="number">2016</span> - [error][/usr/local/share/perl5/MHA/SSHCheck.pm, ln111] SSH connection from mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>:<span class="number">22</span>) to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>:<span class="number">22</span>) failed!</div></pre></td></tr></table></figure>
<p>日志内容很眼熟（SSHCheck.pm, ln111），内容为结论性判定。并且，它会将临时日志打回到最上层父进程。也就是说，我们启动masterha_manager后，这块内容会被写入/usr/local/mha-manager/logs/test.log</p>
<p><strong>所以，Permission denied (publickey,password)为结论性判定，并阐述ssh连接失败的原因；SSH connection from X to Y failed!作为工作日志进行解释性描述</strong></p>
<p>还有一个总结性的返回，阐述check失败！</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">semi-panic: attempt <span class="built_in">to</span> dup freed <span class="keyword">string</span> <span class="keyword">at</span> /usr/<span class="built_in">local</span>/share/perl5/Carp.pm <span class="built_in">line</span> <span class="number">229.</span></div><div class="line">错误输入处理，Carp负责将产生错误的子命令行位置打印出来，也就是更清晰的说明报错信息</div><div class="line"></div><div class="line">SSH Configuration Check Failed!</div><div class="line"> <span class="keyword">at</span> /usr/<span class="built_in">local</span>/mha-manager/bin/masterha_check_ssh <span class="built_in">line</span> <span class="number">44.</span></div></pre></td></tr></table></figure>
<p>masterha_check_ssh line 44<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">44 exit <span class="attribute">MHA</span>::<span class="attribute">SSHCheck</span>::main(<span class="variable">@ARGV</span>);</div></pre></td></tr></table></figure></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://mckobe23.github.io/2016/03/22/mha-check-ssh/" data-id="cit18636p0007oxfycsnfqaeg" class="article-share-link">Share</a><div class="tags"><a href="/tags/mysql/">mysql</a><a href="/tags/mha/">mha</a></div><div class="post-nav"><a href="/2016/03/23/mha-check-repl/" class="pre">MHA检测之masterha_check_repl</a><a href="/2016/03/10/utf8mb4/" class="next">utf8转换utf8mb4引发的问题</a></div><div id="disqus_thread"><script>var disqus_shortname = 'mckobe23';
var disqus_identifier = '2016/03/22/mha-check-ssh/';
var disqus_title = 'MHA检测之masterha_check_ssh';
var disqus_url = 'http://mckobe23.github.io/2016/03/22/mha-check-ssh/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mckobe23.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://mckobe23.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/mongodb/">mongodb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/not-null/" style="font-size: 15px;">not null</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/innodb/" style="font-size: 15px;">innodb</a> <a href="/tags/tokudb/" style="font-size: 15px;">tokudb</a> <a href="/tags/replace-into/" style="font-size: 15px;">replace into</a> <a href="/tags/auto-increment/" style="font-size: 15px;">auto increment</a> <a href="/tags/explain/" style="font-size: 15px;">explain</a> <a href="/tags/key-len/" style="font-size: 15px;">key_len</a> <a href="/tags/mha/" style="font-size: 15px;">mha</a> <a href="/tags/myisam/" style="font-size: 15px;">myisam</a> <a href="/tags/osc/" style="font-size: 15px;">osc</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/mongodb/" style="font-size: 15px;">mongodb</a> <a href="/tags/semi-sync/" style="font-size: 15px;">semi-sync</a> <a href="/tags/sqlserver/" style="font-size: 15px;">sqlserver</a> <a href="/tags/oracle/" style="font-size: 15px;">oracle</a> <a href="/tags/update/" style="font-size: 15px;">update</a> <a href="/tags/utf8mb4/" style="font-size: 15px;">utf8mb4</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/08/18/key-length/">EXPLAIN key_length</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/10/null2notnull/">关于NULL to NOT NULL</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/10/redis-info-output-format/">Redis INFO输出文本后的编码问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/28/autoincrment-conflict/">自增主键同步差异后的故障切换，自增主键冲突</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/22/replace-autoincrement/">Replace into 带来的主从自增主键差异</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/07/mongodb-deploy/">MongoDB部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/06/redis-deploy/">Redis部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/30/update-snytax/">UPDATE SYNTAX</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/23/osc/">pt-osc工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/10/engine-innodb/">MySQL存储引擎InnoDB</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//mckobe23.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://hbprotoss.github.io" title="hbprotoss的博客" target="_blank">hbprotoss的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">喀秋莎的技术博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>