<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="快乐每一天 夏虫不可以语冰"><title>MHA检测之masterha_check_repl | 喀秋莎的技术博客</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">MHA检测之masterha_check_repl</h1><a id="logo" href="/.">喀秋莎的技术博客</a><p class="description">快乐每一天 夏虫不可以语冰</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">MHA检测之masterha_check_repl</h1><div class="post-meta">Mar 23, 2016<span> | </span><span class="category"><a href="/categories/mysql/">mysql</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/03/23/mha-check-repl/" href="/2016/03/23/mha-check-repl/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h3 id="MHA有两个重要的检测工具，分别用来验证节点间主机通讯和主从关系健康情况"><a href="#MHA有两个重要的检测工具，分别用来验证节点间主机通讯和主从关系健康情况" class="headerlink" title="MHA有两个重要的检测工具，分别用来验证节点间主机通讯和主从关系健康情况"></a>MHA有两个重要的检测工具，分别用来验证节点间主机通讯和主从关系健康情况</h3><p><strong>masterha_check_repl</strong><br>负责检测ssh通讯是否正常，并且会在masterha_manager和masterha_check_repl脚本启动的时候，被调用</p>
<p>Manager访问节点实例，需要通过ssh<br>Node从库节点间拷贝relay log，需要通过ssh<br>（这也就是为什么我们在安装时需要建立主机之间的信任关系）</p>
<p><strong>环境</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">manager</span> 10<span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.209</span></div><div class="line"><span class="selector-tag">node1</span>	10<span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.202</span></div><div class="line"><span class="selector-tag">node2</span>	10<span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.203</span></div><div class="line"><span class="selector-tag">node3</span>	10<span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.204</span></div><div class="line"><span class="selector-tag">node4</span>	10<span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.210</span></div></pre></td></tr></table></figure>
<p>这里我们使用了1主3从，共4个节点。网上很多是按3个节点来的，而实际的工作中，我们很可能为了负载读，会建立n个从库，那么就来的真实一点，看看超过3个节点的时候，MHA是如何工作的</p>
<p>PS：并且我们将Manager单分出去，也不同于官方或者网上选择某一个节点兼职Manager。也算规划的一部分吧，我们可以在这台Manager上面管理n组集群（当然，你也可以为它做HA）</p>
<p><strong>repl检测</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div></pre></td><td class="code"><pre><div class="line">[mha@n-op-209 etc]$ masterha_check_repl <span class="comment">--conf=/usr/local/mha-manager/etc/test.conf</span></div><div class="line"></div><div class="line">Fri Mar 25 12:13:19 2016 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</div><div class="line">Fri Mar 25 12:13:19 2016 - [info] Reading application default configuration from /usr/local/mha-manager/etc/test.conf..</div><div class="line">Fri Mar 25 12:13:19 2016 - [info] Reading server configuration from /usr/local/mha-manager/etc/test.conf..</div><div class="line"></div><div class="line">Fri Mar 25 12:13:19 2016 - [info] MHA::MasterMonitor version 0.56.</div><div class="line">MHA Monitor的版本信息</div><div class="line"></div><div class="line">Fri Mar 25 12:13:20 2016 - [info] GTID failover mode = 0</div><div class="line">MySQL的GTID设置，我们是关闭的</div><div class="line"></div><div class="line">Fri Mar 25 12:13:20 2016 - [info] Dead Servers:</div><div class="line">挂掉的主机列表(ok，这里没有）</div><div class="line"></div><div class="line">Fri Mar 25 12:13:20 2016 - [info] Alive Servers:</div><div class="line">Fri Mar 25 12:13:20 2016 - [info]   10.20.64.202(10.20.64.202:3306)</div><div class="line">Fri Mar 25 12:13:20 2016 - [info]   10.20.64.203(10.20.64.203:3306)</div><div class="line">Fri Mar 25 12:13:20 2016 - [info]   10.20.64.204(10.20.64.204:3306)</div><div class="line">Fri Mar 25 12:13:20 2016 - [info]   10.20.64.210(10.20.64.210:3306)</div><div class="line">存活的主机列表，是的没错，我们的4个节点都是活着的</div><div class="line"></div><div class="line">Fri Mar 25 12:13:20 2016 - [info] Alive Slaves:</div><div class="line">以下为从节点的详细信息</div><div class="line"></div><div class="line">Fri Mar 25 12:13:20 2016 - [info]   10.20.64.203(10.20.64.203:3306)  Version=5.6.27-76.0-log (oldest major version between slaves) log-bin:enabled</div><div class="line">检测binlog是否开启</div><div class="line"></div><div class="line">Fri Mar 25 12:13:20 2016 - [info]     Replicating from 10.20.64.202(10.20.64.202:3306)</div><div class="line">检测自己是哪个节点的从库</div><div class="line"></div><div class="line">Fri Mar 25 12:13:20 2016 - [info]     Primary candidate for the new Master (candidate_master is <span class="keyword">set</span>)</div><div class="line">第一个新主候选者身份</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info]   <span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span>:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.6</span><span class="number">.27</span><span class="number">-76.0</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span>:<span class="number">3306</span>)</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">第二个新主候选者身份</div><div class="line">（与第一个同级别竞选新主，与检测顺序无关）</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info]   <span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span>:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.6</span><span class="number">.27</span><span class="number">-76.0</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span>:<span class="number">3306</span>)</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the <span class="keyword">new</span> <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">非候选者身份，永远不会成为新主库</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: <span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span>:<span class="number">3306</span>)</div><div class="line">识别当前主库</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info] Checking <span class="keyword">slave</span> configurations..</div><div class="line">连接从库实例，检测从库配置</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info]  read_only=<span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="keyword">on</span> <span class="keyword">slave</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.203</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.203</span>:<span class="number">3306</span>).</div><div class="line">这里会检测read_only参数，如果从库没有用这个参数控制外部写入，mha会打印一个info出来</div><div class="line">（如果read_only=<span class="number">1</span>，mha不会打印任何关于<span class="keyword">read</span> <span class="keyword">only</span>的信息）</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [<span class="keyword">warning</span>]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="keyword">on</span> <span class="keyword">slave</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.203</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.203</span>:<span class="number">3306</span>).</div><div class="line">这里还会检测relay_log_purge参数，如果从库不自动删除relay <span class="keyword">log</span>，mha会打印一个<span class="keyword">warning</span></div><div class="line">（如果relay_log_purge=<span class="number">0</span>，mha不会打印任何关于relay <span class="keyword">log</span> <span class="keyword">purge</span>的信息）</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info]  read_only=<span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="keyword">on</span> <span class="keyword">slave</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span>:<span class="number">3306</span>).</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [<span class="keyword">warning</span>]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="keyword">on</span> <span class="keyword">slave</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span>:<span class="number">3306</span>).</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info]  read_only=<span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="keyword">on</span> <span class="keyword">slave</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span>:<span class="number">3306</span>).</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [<span class="keyword">warning</span>]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="keyword">on</span> <span class="keyword">slave</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span>:<span class="number">3306</span>).</div><div class="line"></div><div class="line">(总结：如果所有从库read_only=<span class="number">1</span> <span class="keyword">and</span> relay_log_purge=<span class="number">0</span>，这块不会打印任何内容）</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info] Checking <span class="keyword">replication</span> filtering settings..</div><div class="line">连接从库实例，检测从库同步过滤配置</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info]  binlog_do_db= , binlog_ignore_db=</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info]  <span class="keyword">Replication</span> filtering <span class="keyword">check</span> ok.</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info] GTID (<span class="keyword">with</span> <span class="keyword">auto</span>-pos) <span class="keyword">is</span> <span class="keyword">not</span> supported</div><div class="line">检测GTID，我们的实例没有使用GTID同步，所以这里显示不支持</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">20</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> SSH <span class="keyword">connection</span> tests..</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">23</span> <span class="number">2016</span> - [info] All SSH <span class="keyword">connection</span> tests passed successfully.</div><div class="line">这里开始了排列组合式的ssh检测，这里只显示成功与否</div><div class="line">（你也可以使用<span class="comment">--skip_check_ssh跳过ssh检查）</span></div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">23</span> <span class="number">2016</span> - [info] Checking MHA Node version..</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">2016</span> - [info]  <span class="keyword">Version</span> <span class="keyword">check</span> ok.</div><div class="line">检测MHA的节点版本</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">2016</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">settings</span> <span class="keyword">on</span> the <span class="keyword">current</span> master..</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">2016</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span> <span class="keyword">is</span> reachable.</div><div class="line">检测主库SSH通信</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">2016</span> - [info] <span class="keyword">Master</span> MHA Node <span class="keyword">version</span> <span class="keyword">is</span> <span class="number">0.56</span>.</div><div class="line">显示主库MHA节点版本（这个打印顺序也是醉了）</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">2016</span> - [info] Checking <span class="keyword">recovery</span> script configurations <span class="keyword">on</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span>:<span class="number">3306</span>)..</div><div class="line">检测主库恢复脚本执行是否正常</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">2016</span> - [info]   Executing command: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysqldata/3306/binlog --output_file=/usr/local/mha-node/apps/test/save_binary_logs_test --manager_version=0.56 --start_file=mysql-bin.000001	</span></div><div class="line">使用节点脚本save_binary_logs，观察其工作是否正常，下面是脚本输出</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">2016</span> - [info]   Connecting <span class="keyword">to</span> mha@<span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span>:<span class="number">22</span>)..</div><div class="line">  Creating /usr/<span class="keyword">local</span>/mha-node/apps/<span class="keyword">test</span> <span class="keyword">if</span> <span class="keyword">not</span> exists..    ok.</div><div class="line">检测应用项目目录是否存在，如果不存在MHA会自动创建</div><div class="line"></div><div class="line">  Checking <span class="keyword">output</span> <span class="keyword">directory</span> <span class="keyword">is</span> <span class="keyword">accessible</span> <span class="keyword">or</span> not..</div><div class="line">   ok.</div><div class="line">检测<span class="keyword">binlog</span>输出存放目录访问情况</div><div class="line"></div><div class="line">  <span class="keyword">Binlog</span> <span class="keyword">found</span> <span class="keyword">at</span> /<span class="keyword">data</span>/mysqldata/<span class="number">3306</span>/<span class="keyword">binlog</span>, up <span class="keyword">to</span> mysql-<span class="keyword">bin</span><span class="number">.000001</span></div><div class="line">找到指定的<span class="keyword">binlog</span></div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">2016</span> - [info] <span class="keyword">Binlog</span> setting <span class="keyword">check</span> done.</div><div class="line">到此<span class="keyword">binlog</span>配置检测完成</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">2016</span> - [info] Checking SSH publickey <span class="keyword">authentication</span> <span class="keyword">and</span> checking <span class="keyword">recovery</span> script configurations <span class="keyword">on</span> all alive <span class="keyword">slave</span> servers..</div><div class="line">检测从库SSH通信，并且检测所有从库恢复脚本配置情况，下面的命令将逐个检测</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">2016</span> - [info]   Executing command : apply_diff_relay_logs <span class="comment">--command=test --slave_user='mha' --slave_host=10.20.64.203 --slave_ip=10.20.64.203 --slave_port=3306 --workdir=/usr/local/mha-node/apps/test --target_version=5.6.27-76.0-log --manager_version=0.56 --client_bindir=/usr/local/mysql/bin --client_libdir=/usr/local/mysql/lib --relay_dir=/data/mysqldata/3306/binlog --current_relay_log=relay-bin.000003  --slave_pass=xxx</span></div><div class="line">使用节点脚本apply_diff_relay_logs，观察其工作是否正常，下面是脚本输出</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">24</span> <span class="number">2016</span> - [info]   Connecting <span class="keyword">to</span> mha@<span class="number">10.20</span><span class="number">.64</span><span class="number">.203</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.203</span>:<span class="number">22</span>)..</div><div class="line">  Checking <span class="keyword">slave</span> <span class="keyword">recovery</span> environment settings..</div><div class="line">    Relay <span class="keyword">log</span> <span class="keyword">found</span> <span class="keyword">at</span> /<span class="keyword">data</span>/mysqldata/<span class="number">3306</span>/<span class="keyword">binlog</span>, up <span class="keyword">to</span> relay-<span class="keyword">bin</span><span class="number">.000003</span></div><div class="line">找到指定的relay <span class="keyword">log</span></div><div class="line"></div><div class="line">    <span class="keyword">Temporary</span> relay <span class="keyword">log</span> <span class="keyword">file</span> <span class="keyword">is</span> /<span class="keyword">data</span>/mysqldata/<span class="number">3306</span>/<span class="keyword">binlog</span>/relay-<span class="keyword">bin</span><span class="number">.000003</span></div><div class="line">目前临时的relay <span class="keyword">log</span>文件名</div><div class="line"></div><div class="line">    Testing mysql <span class="keyword">connection</span> <span class="keyword">and</span> privileges..Warning: <span class="keyword">Using</span> a <span class="keyword">password</span> <span class="keyword">on</span> the command line <span class="keyword">interface</span> can be insecure.</div><div class="line"> done.</div><div class="line">测试连接和访问权限，警告：在命令行输入密码是不安全的</div><div class="line"></div><div class="line">    Testing mysqlbinlog output.. done.</div><div class="line">使用mysqlbinlog命令测试relay <span class="keyword">log</span>内容输出是否正常</div><div class="line"></div><div class="line">    Cleaning up <span class="keyword">test</span> <span class="keyword">file</span>(s).. done.</div><div class="line">清理测试临时文件</div><div class="line">（到此node1检测完毕）   </div><div class="line">    </div><div class="line">以此类推</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info]   Executing command : apply_diff_relay_logs <span class="comment">--command=test --slave_user='mha' --slave_host=10.20.64.204 --slave_ip=10.20.64.204 --slave_port=3306 --workdir=/usr/local/mha-node/apps/test --target_version=5.6.27-76.0-log --manager_version=0.56 --client_bindir=/usr/local/mysql/bin --client_libdir=/usr/local/mysql/lib --relay_dir=/data/mysqldata/3306/binlog --current_relay_log=relay-bin.000002  --slave_pass=xxx</span></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info]   Connecting <span class="keyword">to</span> mha@<span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span>:<span class="number">22</span>)..</div><div class="line">  Checking <span class="keyword">slave</span> <span class="keyword">recovery</span> environment settings..</div><div class="line">    Relay <span class="keyword">log</span> <span class="keyword">found</span> <span class="keyword">at</span> /<span class="keyword">data</span>/mysqldata/<span class="number">3306</span>/<span class="keyword">binlog</span>, up <span class="keyword">to</span> relay-<span class="keyword">bin</span><span class="number">.000002</span></div><div class="line">    <span class="keyword">Temporary</span> relay <span class="keyword">log</span> <span class="keyword">file</span> <span class="keyword">is</span> /<span class="keyword">data</span>/mysqldata/<span class="number">3306</span>/<span class="keyword">binlog</span>/relay-<span class="keyword">bin</span><span class="number">.000002</span></div><div class="line">    Testing mysql <span class="keyword">connection</span> <span class="keyword">and</span> privileges..Warning: <span class="keyword">Using</span> a <span class="keyword">password</span> <span class="keyword">on</span> the command line <span class="keyword">interface</span> can be insecure.</div><div class="line"> done.</div><div class="line">    Testing mysqlbinlog output.. done.</div><div class="line">    Cleaning up <span class="keyword">test</span> <span class="keyword">file</span>(s).. done.</div><div class="line">（到此node2检测完毕）   </div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info]   Executing command : apply_diff_relay_logs <span class="comment">--command=test --slave_user='mha' --slave_host=10.20.64.210 --slave_ip=10.20.64.210 --slave_port=3306 --workdir=/usr/local/mha-node/apps/test --target_version=5.6.27-76.0-log --manager_version=0.56 --client_bindir=/usr/local/mysql/bin --client_libdir=/usr/local/mysql/lib --relay_dir=/data/mysqldata/3306/binlog --current_relay_log=relay-bin.000002  --slave_pass=xxx</span></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info]   Connecting <span class="keyword">to</span> mha@<span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span>:<span class="number">22</span>)..</div><div class="line">Creating <span class="keyword">directory</span> /usr/<span class="keyword">local</span>/mha-node/apps/test.. done.</div><div class="line">  Checking <span class="keyword">slave</span> <span class="keyword">recovery</span> environment settings..</div><div class="line">    Relay <span class="keyword">log</span> <span class="keyword">found</span> <span class="keyword">at</span> /<span class="keyword">data</span>/mysqldata/<span class="number">3306</span>/<span class="keyword">binlog</span>, up <span class="keyword">to</span> relay-<span class="keyword">bin</span><span class="number">.000002</span></div><div class="line">    <span class="keyword">Temporary</span> relay <span class="keyword">log</span> <span class="keyword">file</span> <span class="keyword">is</span> /<span class="keyword">data</span>/mysqldata/<span class="number">3306</span>/<span class="keyword">binlog</span>/relay-<span class="keyword">bin</span><span class="number">.000002</span></div><div class="line">    Testing mysql <span class="keyword">connection</span> <span class="keyword">and</span> privileges..Warning: <span class="keyword">Using</span> a <span class="keyword">password</span> <span class="keyword">on</span> the command line <span class="keyword">interface</span> can be insecure.</div><div class="line"> done.</div><div class="line">    Testing mysqlbinlog output.. done.</div><div class="line">    Cleaning up <span class="keyword">test</span> <span class="keyword">file</span>(s).. done.</div><div class="line">（到此node3检测完毕）   </div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Slaves <span class="keyword">settings</span> <span class="keyword">check</span> done.</div><div class="line">到此从库<span class="keyword">binlog</span>、relay <span class="keyword">log</span>配置检测完毕</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info]</div><div class="line"><span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span>(<span class="number">10.20</span><span class="number">.64</span><span class="number">.202</span>:<span class="number">3306</span>) (<span class="keyword">current</span> <span class="keyword">master</span>) (<span class="keyword">test</span> <span class="keyword">master</span>)</div><div class="line"> +<span class="comment">--10.20.64.203(10.20.64.203:3306) (test standby)</span></div><div class="line"> +<span class="comment">--10.20.64.204(10.20.64.204:3306) (test standby)</span></div><div class="line"> +<span class="comment">--10.20.64.210(10.20.64.210:3306) (test slave)</span></div><div class="line">根据配置文件，以树形显示<span class="number">1</span>个主库，<span class="number">2</span>个候选人从库，<span class="number">1</span>个非候选人从库</div><div class="line"></div><div class="line">下面是从库同步检测</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Checking <span class="keyword">replication</span> health <span class="keyword">on</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.203</span>..</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">(node1同步正常）</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Checking <span class="keyword">replication</span> health <span class="keyword">on</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.204</span>..</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">(node2同步正常）</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Checking <span class="keyword">replication</span> health <span class="keyword">on</span> <span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span>..</div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">(node3同步正常）</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [<span class="keyword">warning</span>] master_ip_failover_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</div><div class="line">警告：未定义master_ip_failover_script脚本</div><div class="line">（因为我们的配置中注意注释了这行，将来使用自定义的脚本替换原生脚本）</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [<span class="keyword">warning</span>] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</div><div class="line">警告：未定义shutdown_script脚本</div><div class="line">（因为我们的配置中注意注释了这行，将来使用自定义的脚本替换原生脚本）</div><div class="line"></div><div class="line">Fri Mar <span class="number">25</span> <span class="number">12</span>:<span class="number">13</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Got <span class="keyword">exit</span> code <span class="number">0</span> (<span class="keyword">Not</span> <span class="keyword">master</span> dead).</div><div class="line">本脚本赶回<span class="number">0</span>值（主库没挂）</div><div class="line">（PS：原生脚本打印很简单易懂，<span class="number">0</span>值表示无错误返回）</div><div class="line"></div><div class="line">MySQL <span class="keyword">Replication</span> Health <span class="keyword">is</span> OK.</div><div class="line">同步很健康</div><div class="line">至此检测完毕</div></pre></td></tr></table></figure>
<p>下面我们停掉node2的同步，再来看看check_repl是如何工作的</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">当前同步状态 </div><div class="line"><span class="literal">yes</span>,<span class="literal">yes</span></div><div class="line"></div><div class="line">停止同步</div><div class="line">stop slave;</div><div class="line"><span class="literal">no</span>,<span class="literal">no</span></div></pre></td></tr></table></figure>
<p>再次check_repl</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">[mha@n-op-<span class="number">209</span> etc]$ masterha_check_repl --conf=/usr/local/mha-manager/etc/<span class="keyword">test</span>.conf</div><div class="line"></div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">02</span> <span class="number">2016</span> - [warning] <span class="meta">Global</span> configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">02</span> <span class="number">2016</span> - [info] Reading application <span class="meta">default</span> configuration from /usr/local/mha-manager/etc/<span class="keyword">test</span>.conf..</div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">02</span> <span class="number">2016</span> - [info] Reading server configuration from /usr/local/mha-manager/etc/<span class="keyword">test</span>.conf..</div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">02</span> <span class="number">2016</span> - [info] MHA::MasterMonitor version <span class="number">0.56</span>.</div><div class="line"></div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">03</span> <span class="number">2016</span> - [warning] SQL Thread is stopped(no error) on <span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>:<span class="number">3306</span>)</div><div class="line">第一时间警告：node1的SQL Thread线程停止（且slave status没有报错内容）</div><div class="line"></div><div class="line">...</div><div class="line">以下信息同上测检测，直到</div><div class="line">...</div><div class="line"></div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   Executing command : apply_diff_relay_logs --command=<span class="keyword">test</span> --slave_user=<span class="string">'mha'</span> --slave_host=<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span> --slave_ip=<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span> --slave_port=<span class="number">3306</span> --workdir=/usr/local/mha-node/apps/<span class="keyword">test</span> --target_version=<span class="number">5.6</span><span class="meta">.27</span>-<span class="number">76.0</span>-log --manager_version=<span class="number">0.56</span> --client_bindir=/usr/local/mysql/bin --client_libdir=/usr/local/mysql/lib --relay_dir=/data/mysqldata/<span class="number">3306</span>/binlog --current_relay_log=relay-bin<span class="meta">.000019</span>  --slave_pass=xxx</div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   Connecting to mha@<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>:<span class="number">22</span>)..</div><div class="line">  Checking slave recovery environment settings..</div><div class="line">    Relay log found <span class="meta">at</span> /data/mysqldata/<span class="number">3306</span>/binlog, <span class="meta">up</span> to relay-bin<span class="meta">.000019</span></div><div class="line">    Temporary relay log file is /data/mysqldata/<span class="number">3306</span>/binlog/relay-bin<span class="meta">.000019</span></div><div class="line">    Testing mysql connection <span class="keyword">and</span> privileges..Warning: Using a password on the command line interface can be insecure.</div><div class="line"> done.</div><div class="line">    Testing mysqlbinlog output.. done.</div><div class="line">    Cleaning <span class="meta">up</span> <span class="keyword">test</span> file(s).. done.</div><div class="line">无报错，仅打印当起从库relay log信息   </div><div class="line"></div><div class="line">...</div><div class="line">其他信息同上次检测，直到</div><div class="line">... </div><div class="line"></div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">09</span> <span class="number">2016</span> - [info] Slaves settings check done.</div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">09</span> <span class="number">2016</span> - [info]</div><div class="line"><span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.202</span>:<span class="number">3306</span>) (current master) (<span class="keyword">test</span> master)</div><div class="line"> +--<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>:<span class="number">3306</span>) (<span class="keyword">test</span> standby)</div><div class="line"> +--<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.204</span>:<span class="number">3306</span>) (<span class="keyword">test</span> standby)</div><div class="line"> +--<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.210</span>:<span class="number">3306</span>) (<span class="keyword">test</span> slave)</div><div class="line">这里仅打印MHA配置信息，不要混淆</div><div class="line"></div><div class="line">下面是从库同步检测</div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">09</span> <span class="number">2016</span> - [info] Checking replication health on <span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>..</div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">09</span> <span class="number">2016</span> - [error][/usr/local/share/perl5/MHA/Server.pm, ln485] Slave IO thread is <span class="keyword">not</span> running on <span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>(<span class="number">10.20</span><span class="meta">.64</span><span class="meta">.203</span>:<span class="number">3306</span>)</div><div class="line">检测到IO线程停止工作</div><div class="line"></div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">09</span> <span class="number">2016</span> - [error][/usr/local/share/perl5/MHA/ServerManager.pm, ln1526]  failed!</div><div class="line">仅打印：失败！</div><div class="line"></div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">09</span> <span class="number">2016</span> - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln424] Error happened on checking configurations.  <span class="meta">at</span> /usr/local/share/perl5/MHA/MasterMonitor.pm line <span class="number">417</span>.</div><div class="line">在检测配置时出现报错</div><div class="line">	</div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">09</span> <span class="number">2016</span> - [error][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln523] Error happened on monitoring servers.</div><div class="line">监控服务器时出现报错</div><div class="line"></div><div class="line">Tue Apr  <span class="number">5</span> <span class="number">12</span>:<span class="number">32</span>:<span class="number">09</span> <span class="number">2016</span> - [info] Got exit code <span class="number">1</span> (<span class="keyword">Not</span> master dead).</div><div class="line">本脚本赶回<span class="number">1</span>值（主库没挂）</div><div class="line">（PS：<span class="number">1</span>值表示错误退出）</div><div class="line"></div><div class="line">这里我们看到，当出现一个同步异常，后续的从库同步检查也不做了</div><div class="line"></div><div class="line">MySQL Replication Health is <span class="keyword">NOT</span> OK!</div><div class="line">同步不健康</div><div class="line">到此检测完毕</div></pre></td></tr></table></figure>
<p>可以看到repl检测是分两段式返回的</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">Server</span><span class="selector-class">.pm</span>, <span class="selector-tag">ln485</span>:          <span class="selector-tag">Slave</span> <span class="selector-tag">IO</span> <span class="selector-tag">thread</span> <span class="selector-tag">is</span> <span class="selector-tag">not</span> <span class="selector-tag">running</span> <span class="selector-tag">on</span> 10<span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.203</span>(10<span class="selector-class">.20</span><span class="selector-class">.64</span><span class="selector-class">.203</span><span class="selector-pseudo">:3306)</span></div><div class="line"></div><div class="line"><span class="selector-tag">ServerManager</span><span class="selector-class">.pm</span>，<span class="selector-tag">ln1526</span>:  <span class="selector-tag">failed</span>!</div></pre></td></tr></table></figure>
<p><strong>ssh检测那篇我们提到，它是通过fork进程来完成的，现在我们来看看repl检测是如何实现的</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">MasterMonitor<span class="selector-class">.pm</span>, ln424:	Error happened on checking configurations.</div><div class="line">MasterMonitor<span class="selector-class">.pm</span> line <span class="number">417</span></div><div class="line"></div><div class="line">MasterMonitor<span class="selector-class">.pm</span>, ln523:  Error happened on monitoring servers.</div></pre></td></tr></table></figure>
<p>这是一些总结性报错的可忽略</p>
<h4 id="我们来看看Server-pm-ln485和ServerManager-pm-ln1526在干嘛"><a href="#我们来看看Server-pm-ln485和ServerManager-pm-ln1526在干嘛" class="headerlink" title="我们来看看Server.pm, ln485和ServerManager.pm, ln1526在干嘛"></a>我们来看看Server.pm, ln485和ServerManager.pm, ln1526在干嘛</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">Server.pm</div><div class="line"></div><div class="line"> <span class="number">1</span> <span class="comment">#!/usr/bin/env perl</span></div><div class="line">  ...</div><div class="line"><span class="number">30</span> <span class="keyword">use</span> MHA::DBHelper;</div><div class="line">  ...</div><div class="line"><span class="number">66</span> <span class="function"><span class="keyword">sub</span> <span class="title">check_slave_status</span>($) </span>&#123;</div><div class="line"><span class="number">67</span>   <span class="keyword">my</span> $self     = <span class="keyword">shift</span>;</div><div class="line"><span class="number">68</span>   <span class="keyword">my</span> $dbhelper = $self-&gt;&#123;dbhelper&#125;;</div><div class="line"><span class="number">69</span>   <span class="keyword">return</span> $dbhelper-&gt;check_slave_status();</div><div class="line"><span class="number">70</span> &#125;</div><div class="line">  ...</div><div class="line"><span class="number">471</span> <span class="comment">#Check whether slave is running and not delayed</span></div><div class="line"><span class="number">472</span> <span class="function"><span class="keyword">sub</span> <span class="title">has_replication_problem</span> </span>&#123;</div><div class="line"><span class="number">473</span>   <span class="keyword">my</span> $self                = <span class="keyword">shift</span>;</div><div class="line"><span class="number">474</span>   <span class="keyword">my</span> $allow_delay_seconds = <span class="keyword">shift</span>;</div><div class="line"><span class="number">475</span>   $allow_delay_seconds = <span class="number">1</span> <span class="keyword">unless</span> ($allow_delay_seconds);</div><div class="line"><span class="number">476</span>   <span class="keyword">my</span> $log      = $self-&gt;&#123;logger&#125;;</div><div class="line"><span class="number">477</span>   <span class="keyword">my</span> $dbhelper = $self-&gt;&#123;dbhelper&#125;;</div><div class="line"><span class="number">478</span>   <span class="keyword">my</span> %status   = $dbhelper-&gt;check_slave_status();</div><div class="line"><span class="number">479</span>   <span class="keyword">if</span> ( $status<span class="string">&#123;Status&#125;</span> <span class="keyword">ne</span> <span class="string">'0'</span> ) &#123;</div><div class="line"><span class="number">480</span>     $log-&gt;error(</div><div class="line"><span class="number">481</span>       <span class="keyword">sprintf</span>( <span class="string">"Getting slave status failed on %s"</span>, $self-&gt;get_hostinfo() ) );</div><div class="line"><span class="number">482</span>     <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line"><span class="number">483</span>   &#125;</div><div class="line"><span class="number">484</span>   <span class="keyword">elsif</span> ( $status<span class="string">&#123;Slave_IO_Running&#125;</span> <span class="keyword">ne</span> <span class="string">"Yes"</span> ) &#123;</div><div class="line"><span class="number">485</span>     $log-&gt;error(</div><div class="line"><span class="number">486</span>       <span class="keyword">sprintf</span>( <span class="string">"Slave IO thread is not running on %s"</span>, $self-&gt;get_hostinfo() )</div><div class="line"><span class="number">487</span>     );</div><div class="line"><span class="number">488</span>     <span class="keyword">return</span> <span class="number">2</span>;</div><div class="line"><span class="number">489</span>   &#125;</div><div class="line"><span class="number">490</span>   <span class="keyword">elsif</span> ( $status<span class="string">&#123;Slave_SQL_Running&#125;</span> <span class="keyword">ne</span> <span class="string">"Yes"</span> ) &#123;</div><div class="line"><span class="number">491</span>     $log-&gt;error(</div><div class="line"><span class="number">492</span>       <span class="keyword">sprintf</span>( <span class="string">"Slave SQL thread is not running on %s"</span>, $self-&gt;get_hostinfo() )</div><div class="line"><span class="number">493</span>     );</div><div class="line"><span class="number">494</span>     <span class="keyword">return</span> <span class="number">3</span>;</div><div class="line"><span class="number">495</span>   &#125;</div><div class="line"><span class="number">496</span>   <span class="keyword">elsif</span> ( $status<span class="string">&#123;Seconds_Behind_Master&#125;</span></div><div class="line"><span class="number">497</span>     &amp;&amp; $status<span class="string">&#123;Seconds_Behind_Master&#125;</span> &gt; $allow_delay_seconds )</div><div class="line"><span class="number">498</span>   &#123;</div><div class="line"><span class="number">499</span>     $log-&gt;error(</div><div class="line"><span class="number">500</span>       <span class="keyword">sprintf</span>(</div><div class="line"><span class="number">501</span>         <span class="string">"Slave is currently behind %d seconds on %s"</span>,</div><div class="line"><span class="number">502</span>         $status<span class="string">&#123;Seconds_Behind_Master&#125;</span>,</div><div class="line"><span class="number">503</span>         $self-&gt;get_hostinfo()</div><div class="line"><span class="number">504</span>       )</div><div class="line"><span class="number">505</span>     );</div><div class="line"><span class="number">506</span>     <span class="keyword">return</span> <span class="number">4</span>;</div><div class="line"><span class="number">507</span>   &#125;</div><div class="line"><span class="number">508</span>   <span class="keyword">elsif</span> ( !<span class="keyword">defined</span>( $status<span class="string">&#123;Seconds_Behind_Master&#125;</span> ) ) &#123;</div><div class="line"><span class="number">509</span>     $log-&gt;error(</div><div class="line"><span class="number">510</span>       <span class="keyword">sprintf</span>( <span class="string">"Failed to get Seconds_Behind_Master on %s"</span>,</div><div class="line"><span class="number">511</span>         $self-&gt;get_hostinfo() )</div><div class="line"><span class="number">512</span>     );</div><div class="line"><span class="number">513</span>     <span class="keyword">return</span> <span class="number">5</span>;</div><div class="line"><span class="number">514</span>   &#125;</div><div class="line"><span class="number">515</span>   <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line"><span class="number">516</span> &#125;</div></pre></td></tr></table></figure>
<p>MHA::DBHelper MHA通过这个模块，获取到从库的状态信息，并将结果打印出来</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">ServerManager.pm</div><div class="line"></div><div class="line"> <span class="number">1</span> <span class="comment">#!/usr/bin/env perl</span></div><div class="line">  ...</div><div class="line"><span class="number">31</span> <span class="keyword">use</span> Parallel::ForkManager;</div><div class="line">  ...</div><div class="line"><span class="number">90</span> <span class="function"><span class="keyword">sub</span> <span class="title">get_alive_slaves</span>($) </span>&#123;</div><div class="line"><span class="number">91</span>   <span class="keyword">my</span> $self = <span class="keyword">shift</span>;</div><div class="line"><span class="number">92</span>   <span class="keyword">return</span> @&#123; $self-&gt;&#123;alive_slaves&#125; &#125;;</div><div class="line"><span class="number">93</span> &#125;</div><div class="line">  ...</div><div class="line"><span class="number">260</span>   <span class="keyword">my</span> $connection_checker = new Parallel::ForkManager( $#servers + <span class="number">1</span> );</div><div class="line">  ...</div><div class="line"><span class="number">1513</span> <span class="function"><span class="keyword">sub</span> <span class="title">check_replication_health</span> </span>&#123;</div><div class="line"><span class="number">1514</span>   <span class="keyword">my</span> $self                = <span class="keyword">shift</span>;</div><div class="line"><span class="number">1515</span>   <span class="keyword">my</span> $allow_delay_seconds = <span class="keyword">shift</span>;</div><div class="line"><span class="number">1516</span>   $allow_delay_seconds = <span class="number">1</span> <span class="keyword">unless</span> ($allow_delay_seconds);</div><div class="line"><span class="number">1517</span>   <span class="keyword">my</span> $log          = $self-&gt;&#123;logger&#125;;</div><div class="line"><span class="number">1518</span>   <span class="keyword">my</span> @alive_slaves = $self-&gt;get_alive_slaves();</div><div class="line"><span class="number">1519</span>   <span class="keyword">foreach</span> <span class="keyword">my</span> $target (@alive_slaves) &#123;</div><div class="line"><span class="number">1520</span>     $log-&gt;info(<span class="string">"Checking replication health on $target-&gt;&#123;hostname&#125;.."</span>);</div><div class="line"><span class="number">1521</span>     <span class="keyword">if</span> ( !$target-&gt;current_slave_position() ) &#123;</div><div class="line"><span class="number">1522</span>       $log-&gt;error(<span class="string">"Getting slave status failed!"</span>);</div><div class="line"><span class="number">1523</span>       croak;</div><div class="line"><span class="number">1524</span>     &#125;</div><div class="line"><span class="number">1525</span>     <span class="keyword">if</span> ( $target-&gt;has_replication_problem($allow_delay_seconds) ) &#123;</div><div class="line"><span class="number">1526</span>       $log-&gt;error(<span class="string">" failed!"</span>);</div><div class="line"><span class="number">1527</span>       croak;</div><div class="line"><span class="number">1528</span>     &#125;</div><div class="line"><span class="number">1529</span>     <span class="keyword">else</span> &#123;</div><div class="line"><span class="number">1530</span>       $log-&gt;info(<span class="string">" ok."</span>);</div><div class="line"><span class="number">1531</span>     &#125;</div><div class="line"><span class="number">1532</span>   &#125;</div><div class="line"><span class="number">1533</span> &#125;</div></pre></td></tr></table></figure>
<p>Parallel::ForkManager 这个模块是通过 Fork 进程而不是创建线程来实现并行处理</p>
<p>这里同ssh检测一样，会Fork进程来检测同步健康</p>
<p>下面我们再次跟踪抓去下脚本运行时的中间过程</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[mha@<span class="keyword">n</span>-op-209 root]$ ps -ef|grep check</div><div class="line">mha      25696 25324 15 15:32 pts/0    00:00:00 perl /usr/<span class="keyword">local</span>/mha-manager/bin/masterha_check_repl --<span class="keyword">conf</span>=/usr/<span class="keyword">local</span>/mha-manager/etc/<span class="keyword">test</span>.<span class="keyword">conf</span></div><div class="line"></div><div class="line">mha      25706 25696  0 15:32 pts/0    00:00:00 perl /usr/<span class="keyword">local</span>/mha-manager/bin/masterha_check_repl --<span class="keyword">conf</span>=/usr/<span class="keyword">local</span>/mha-manager/etc/<span class="keyword">test</span>.<span class="keyword">conf</span></div><div class="line"></div><div class="line">mha      25709 25706  0 15:32 pts/0    00:00:00 <span class="keyword">sh</span> -c ssh -o StrictHostKeyChecking=<span class="keyword">no</span> -o PasswordAuthentication=<span class="keyword">no</span> -o BatchMode=yes -o ConnectTimeout=5 -p 22 mha@10.20.64.202 <span class="string">"ssh -o StrictHostKeyChecking=no -o PasswordAuthentication=no -o BatchMode=yes -o ConnectTimeout=5 -p 22 mha@10.20.64.204 exit 0"</span> &gt;&gt; /usr/<span class="keyword">local</span>/mha-manager/apps/<span class="keyword">test</span>/10.20.64.202_22_ssh_check.<span class="keyword">log</span> 2&gt;&amp;1</div><div class="line"></div><div class="line">[mha@<span class="keyword">n</span>-op-209 root]$ ps -ef|grep check</div><div class="line">mha      25696 25324 15 15:32 pts/0    00:00:00 perl /usr/<span class="keyword">local</span>/mha-manager/bin/masterha_check_repl --<span class="keyword">conf</span>=/usr/<span class="keyword">local</span>/mha-manager/etc/<span class="keyword">test</span>.<span class="keyword">conf</span></div><div class="line"></div><div class="line">mha      25715 25696  0 15:32 pts/0    00:00:00 perl /usr/<span class="keyword">local</span>/mha-manager/bin/masterha_check_repl --<span class="keyword">conf</span>=/usr/<span class="keyword">local</span>/mha-manager/etc/<span class="keyword">test</span>.<span class="keyword">conf</span></div><div class="line"></div><div class="line">mha      25718 25715  0 15:32 pts/0    00:00:00 <span class="keyword">sh</span> -c ssh -o StrictHostKeyChecking=<span class="keyword">no</span> -o PasswordAuthentication=<span class="keyword">no</span> -o BatchMode=yes -o ConnectTimeout=5 -p 22 mha@10.20.64.203 <span class="string">"ssh -o StrictHostKeyChecking=no -o PasswordAuthentication=no -o BatchMode=yes -o ConnectTimeout=5 -p 22 mha@10.20.64.204 exit 0"</span> &gt;&gt; /usr/<span class="keyword">local</span>/mha-manager/apps/<span class="keyword">test</span>/10.20.64.203_22_ssh_check.<span class="keyword">log</span> 2&gt;&amp;1</div></pre></td></tr></table></figure>
<p><strong>25696 是 masterha_check_repl</strong><br><strong>25706和25715 就是 25696的fork进程</strong><br>（这里区别与check ssh，check ssh始终由一个fork进程来管理子进程；而repl的每一次从库检测，都会启动一个新fork，用完关闭）<br><strong>25709和25718 分别是 由25706和25715再fork出来实际干活的</strong></p>
<p>厄。。没错，竟然都是ssh的检测</p>
<p>参数说明和日志抽样参考上一篇check_ssh吧</p>
<p><strong>那repl check在做什么？</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select * from PROCESSLIST where USER='mha'\G</div><div class="line"></div><div class="line">*************************** 1. row ***************************</div><div class="line">           ID: 141</div><div class="line">         USER: mha</div><div class="line">         HOST: 10.20.64.209:36199</div><div class="line">           DB: NULL</div><div class="line">      COMMAND: Sleep</div><div class="line">         TIME: 5</div><div class="line">        STATE:</div><div class="line">         INFO: NULL</div><div class="line">      TIME_MS: 5161</div><div class="line">    ROWS_SENT: 0</div><div class="line">ROWS_EXAMINED: 0</div><div class="line">          TID: 15498</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>MHA在mysql中sleep了5秒，TID: 15498<br><img src="/images/6.pic.jpg" alt="TID"></p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@n-op-<span class="number">210</span> ~]# ps -efL |<span class="keyword">grep</span> <span class="number">15498</span></div><div class="line"></div><div class="line">mysql    <span class="number">12773</span> <span class="number">11617</span> <span class="number">15498</span>  <span class="number">0</span>   <span class="number">26</span> Mar25 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="regexp">/data/</span>percona-mysql5627<span class="regexp">/bin/my</span>sqld --defaults-<span class="keyword">file</span>=<span class="regexp">/data/my</span>sqldata<span class="regexp">/3306/</span>etc<span class="regexp">/my.cnf --basedir=/u</span>sr<span class="regexp">/local/my</span>sql --datadir=<span class="regexp">/data/my</span>sqldata<span class="regexp">/3306/</span>data --plugin-dir=<span class="regexp">/usr/</span>local<span class="regexp">/mysql/</span>lib<span class="regexp">/mysql/</span>plugin --user=mysql --log-error=<span class="regexp">/data/my</span>sqldata<span class="regexp">/3306/my</span>sql-error.log --open-files-limit=<span class="number">65535</span> --pid-<span class="keyword">file</span>=<span class="regexp">/data/my</span>sqldata<span class="regexp">/3306/my</span>sql.pid --socket=<span class="regexp">/data/my</span>sqldata<span class="regexp">/3306/my</span>sql.sock --port=<span class="number">3306</span></div></pre></td></tr></table></figure>
<p><strong>原来这个TID就是node4的mysqld本身产生的，并且每次运行mha-check-repl，这个TID都不变</strong><br>（是不是看的有点晕，首先我的测试机把Thread pool打开了，所以会有这些）</p>
<p><strong>我们打开general_log看看</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">    Time  Id Command Argument</div><div class="line">11:13:28 140 Connect mha@10.20.64.209 on</div><div class="line">         140 Query   <span class="keyword">set</span> autocommit=<span class="number">1</span></div><div class="line">         <span class="number">140</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> CONNECTION_ID() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line"><span class="number">11</span>:<span class="number">13</span>:<span class="number">29</span> <span class="number">141</span> <span class="keyword">Connect</span> mha@<span class="number">10.20</span><span class="number">.64</span><span class="number">.209</span> <span class="keyword">on</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">set</span> autocommit=<span class="number">1</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> CONNECTION_ID() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SET</span> wait_timeout=<span class="number">86400</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.server_id <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> <span class="keyword">VERSION</span>() <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.gtid_mode <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'log_bin'</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">MASTER</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.datadir <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.slave_parallel_workers <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.read_only <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.relay_log_purge <span class="keyword">As</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.relay_log_info_repository <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> Relay_log_name <span class="keyword">FROM</span> mysql.slave_relay_log_info</div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SELECT</span> @@global.datadir <span class="keyword">AS</span> <span class="keyword">Value</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">以上都是mha manager获取状态信息，我们可以从check_repl的日志中找到对应的内容</div><div class="line">         </div><div class="line"><span class="number">11</span>:<span class="number">13</span>:<span class="number">34</span> <span class="number">136</span> <span class="keyword">Query</span>   <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">PROCESSLIST</span> <span class="keyword">where</span> <span class="keyword">USER</span>=<span class="string">'mha'</span></div><div class="line"></div><div class="line">这些是由node脚本apply_diff_relay_logs完成</div><div class="line">         <span class="number">142</span> <span class="keyword">Connect</span> mha@<span class="number">10.20</span><span class="number">.64</span><span class="number">.210</span> <span class="keyword">on</span></div><div class="line">         <span class="number">142</span> <span class="keyword">Query</span>   <span class="keyword">select</span> @@version_comment <span class="keyword">limit</span> <span class="number">1</span></div><div class="line">         <span class="number">142</span> <span class="keyword">Query</span>   <span class="keyword">set</span> sql_log_bin=<span class="number">0</span></div><div class="line">         禁止此<span class="keyword">session</span>写<span class="keyword">binlog</span>，它下面做的事情，不会写入<span class="keyword">binlog</span></div><div class="line">         </div><div class="line">         <span class="number">142</span> <span class="keyword">Query</span>   <span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> mysql.apply_diff_relay_logs_test(<span class="keyword">id</span> <span class="built_in">int</span>) </div><div class="line">         <span class="number">142</span> <span class="keyword">Query</span>   <span class="keyword">insert</span> <span class="keyword">into</span> mysql.apply_diff_relay_logs_test <span class="keyword">values</span>(<span class="number">1</span>)</div><div class="line">         <span class="number">142</span> <span class="keyword">Query</span>   <span class="keyword">update</span> mysql.apply_diff_relay_logs_test <span class="keyword">set</span> <span class="keyword">id</span>=<span class="keyword">id</span>+<span class="number">1</span> <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">1</span></div><div class="line">         <span class="number">142</span> <span class="keyword">Query</span>   <span class="keyword">delete</span> <span class="keyword">from</span> mysql.apply_diff_relay_logs_test</div><div class="line">         <span class="number">142</span> <span class="keyword">Query</span>   <span class="keyword">drop</span> <span class="keyword">table</span> mysql.apply_diff_relay_logs_test</div><div class="line">         <span class="number">142</span> Quit</div><div class="line">         在mysql库下建立测试表apply_diff_relay_logs_test，进行<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">delete</span>,<span class="keyword">drop</span>操作</div><div class="line">         这是在测试实例可用性，退出</div><div class="line">         </div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">141</span> <span class="keyword">Query</span>   <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span></div><div class="line">         <span class="number">141</span> Quit</div><div class="line">         然后再次本地获取下同步状态，退出</div></pre></td></tr></table></figure>
<p>从这里我们可以看出，fork出的进程都是ssh，它是跳到node服务器，执行的node本地脚本</p>
<p>check repl做的事情相比check ssh复杂好多</p>
<p><strong><em>下面我们需要了解的就是node节点的save_binary_logs和apply_diff_relay_logs两个脚本的工作了，放到下一篇吧</em></strong></p>
<p>从check_repl脚本看来，它默认做了两项检测，ssh通信和主从同步。<br>按照官方文档，我们可以忽略ssh检测（--skip_check_ssh）<br>也可以设置延迟阈值来控制报错（--seconds_behind_master=(seconds)）</p>
<p><strong>另外，我们再次使用check_ssh博客的破坏信任的方式测试过，报错日志与check_ssh的一致，这里不再赘述</strong></p>
<p>PS：当检测出现任何异常，check_ssh和check_repl都会exit 1报错退出，不再继续后面node的检测工作</p>
<h4 id="小技巧：在部署完MHA后，官方建议我们使用check-ssh和check-repl先人工检测下。根据上面的经验，我们可以跳过check-ssh，直接使用check-repl来检测，因为它默认也把check-ssh的工作完成了：）"><a href="#小技巧：在部署完MHA后，官方建议我们使用check-ssh和check-repl先人工检测下。根据上面的经验，我们可以跳过check-ssh，直接使用check-repl来检测，因为它默认也把check-ssh的工作完成了：）" class="headerlink" title="小技巧：在部署完MHA后，官方建议我们使用check_ssh和check_repl先人工检测下。根据上面的经验，我们可以跳过check_ssh，直接使用check_repl来检测，因为它默认也把check_ssh的工作完成了：）"></a>小技巧：在部署完MHA后，官方建议我们使用check_ssh和check_repl先人工检测下。根据上面的经验，我们可以跳过check_ssh，直接使用check_repl来检测，因为它默认也把check_ssh的工作完成了：）</h4></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://mckobe23.github.io/2016/03/23/mha-check-repl/" data-id="cit18636x000doxfyyoosurk6" class="article-share-link">Share</a><div class="tags"><a href="/tags/mysql/">mysql</a><a href="/tags/mha/">mha</a></div><div class="post-nav"><a href="/2016/04/01/semi-sync/" class="pre">MySQL半同步注意事项</a><a href="/2016/03/22/mha-check-ssh/" class="next">MHA检测之masterha_check_ssh</a></div><div id="disqus_thread"><script>var disqus_shortname = 'mckobe23';
var disqus_identifier = '2016/03/23/mha-check-repl/';
var disqus_title = 'MHA检测之masterha_check_repl';
var disqus_url = 'http://mckobe23.github.io/2016/03/23/mha-check-repl/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mckobe23.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://mckobe23.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/mongodb/">mongodb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/not-null/" style="font-size: 15px;">not null</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/innodb/" style="font-size: 15px;">innodb</a> <a href="/tags/tokudb/" style="font-size: 15px;">tokudb</a> <a href="/tags/replace-into/" style="font-size: 15px;">replace into</a> <a href="/tags/auto-increment/" style="font-size: 15px;">auto increment</a> <a href="/tags/explain/" style="font-size: 15px;">explain</a> <a href="/tags/key-len/" style="font-size: 15px;">key_len</a> <a href="/tags/mha/" style="font-size: 15px;">mha</a> <a href="/tags/myisam/" style="font-size: 15px;">myisam</a> <a href="/tags/osc/" style="font-size: 15px;">osc</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/mongodb/" style="font-size: 15px;">mongodb</a> <a href="/tags/semi-sync/" style="font-size: 15px;">semi-sync</a> <a href="/tags/sqlserver/" style="font-size: 15px;">sqlserver</a> <a href="/tags/oracle/" style="font-size: 15px;">oracle</a> <a href="/tags/update/" style="font-size: 15px;">update</a> <a href="/tags/utf8mb4/" style="font-size: 15px;">utf8mb4</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/08/18/key-length/">EXPLAIN key_length</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/10/null2notnull/">关于NULL to NOT NULL</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/10/redis-info-output-format/">Redis INFO输出文本后的编码问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/28/autoincrment-conflict/">自增主键同步差异后的故障切换，自增主键冲突</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/22/replace-autoincrement/">Replace into 带来的主从自增主键差异</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/07/mongodb-deploy/">MongoDB部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/06/redis-deploy/">Redis部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/30/update-snytax/">UPDATE SYNTAX</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/23/osc/">pt-osc工具</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/10/engine-innodb/">MySQL存储引擎InnoDB</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//mckobe23.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://hbprotoss.github.io" title="hbprotoss的博客" target="_blank">hbprotoss的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">喀秋莎的技术博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>